<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devinity - Gujarati Voice Bot with Avatar</title>
<style>
body{font-family:Arial;background:#f3f3f3;margin:0}
header{background:#2d3e8b;color:#fff;text-align:center;padding:12px;font-size:18px}
nav{display:flex;background:#fff;border-bottom:1px solid #ccc}
nav button{flex:1;padding:12px;background:#fff;border:none;font-size:20px;cursor:pointer}
nav button.active{background:#e9ecff;font-weight:bold}
.container{padding:15px}
#chatBox{background:#fff;border:1px solid #ddd;height:250px;overflow-y:auto;padding:10px}
.message{margin-bottom:10px}
.user{text-align:right;color:#0a58ca}
.bot{text-align:left}
button{width:100%;padding:10px;margin-top:10px;border:none;font-size:16px;color:#fff;cursor:pointer}
#voiceBtn{background:#1b7c5c}
#stopBtn{background:#d9534f}
#saveKeyBtn{background:#2d3e8b}
#smartLensCameraBtn,#smartLensGalleryBtn{background:#ff9800}
#saveReportBtn{background:#009688}
#saveContactBtn{background:#2d3e8b}
#diaryBtn{background:#9c27b0}
#settingsScreen input,#settingsScreen select{width:100%;padding:10px;margin-top:10px;font-size:16px}
#avatarContainer{display:flex;justify-content:center;margin-bottom:10px;}
</style>
</head>
<body>

<header>Devinity - Gujarati Voice Bot</header>

<nav>
  <button id="chatTab" class="active">ğŸ’¬</button>
  <button id="settingsTab">âš™ï¸</button>
</nav>

<div class="container">

  <!-- AVATAR -->
  <div id="avatarContainer">
    <video id="devinityAvatar" autoplay loop muted playsinline width="200"></video>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chatScreen">
    <div id="chatBox"></div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="voiceBtn" onclick="startListening()">ğŸ¤ àª¬à«‹àª²à«‹</button>
      <button id="stopBtn" onclick="stopListening()">â¹ àª°à«‹àª•à«‹</button>
    </div>
  </div>

  <!-- SETTINGS SCREEN -->
  <div id="settingsScreen" style="display:none">
    <h3>API Key & Model Selection</h3>
    <input type="password" id="apiKeyInput" placeholder="API Key àª¨àª¾àª–à«‹">
    <select id="modelSelect">
      <option value="gpt-4o-mini">OpenAI GPT (Default)</option>
      <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
      <option value="gemini-flash-latest">Gemini Flash Latest</option>
      <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
      <option value="groq-70b">Groq 70B</option>
    </select>
    <button id="saveKeyBtn" onclick="saveSettings()">ğŸ’¾ àª¸àª¾àªšàªµàªµà«‹</button>

    <h3 style="margin-top:20px">ğŸ“· Smart Lens</h3>
    <button id="smartLensCameraBtn" onclick="openCamera()">Camera</button>
    <button id="smartLensGalleryBtn" onclick="openGallery()">Gallery</button>
    <button id="saveReportBtn" style="display:none" onclick="saveReport()">ğŸ’¾ Save Report</button>

    <h3 style="margin-top:20px">ğŸ“‡ àª¸àª‚àªªàª°à«àª• (Contacts)</h3>
    <input type="text" id="contactName" placeholder="Name">
    <input type="text" id="contactNumber" placeholder="Number">
    <button id="saveContactBtn" onclick="addContact()">ğŸ’¾ Add Contact</button>
    <div id="contactList"></div>

    <h3 style="margin-top:20px">ğŸ“ àª¡àª¾àª¯àª°à«€ (Diary)</h3>
    <button id="diaryBtn" onclick="viewDiary()">View Diary</button>
  </div>

</div>

<input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
// ---------------- AVATAR ----------------
const avatarVideos = {
  smiling: "https://raw.githubusercontent.com/yourusername/yourrepo/main/smiling.mp4",
  thinking: "https://raw.githubusercontent.com/yourusername/yourrepo/main/thinking.mp4",
  talking: "https://raw.githubusercontent.com/yourusername/yourrepo/main/talking.mp4",
  silent: "https://raw.githubusercontent.com/yourusername/yourrepo/main/silent.mp4"
};

function setAvatarState(state){
  const video = document.getElementById("devinityAvatar");
  if(!avatarVideos[state]) return;
  video.src = avatarVideos[state];
  video.play();
}

// ---------------- TAB SWITCH ----------------
document.getElementById("chatTab").onclick = ()=>show("chat");
document.getElementById("settingsTab").onclick = ()=>show("settings");

function show(tab){
  document.getElementById("chatScreen").style.display = tab==="chat"?"block":"none";
  document.getElementById("settingsScreen").style.display = tab==="settings"?"block":"none";
  document.getElementById("chatTab").classList.toggle("active",tab==="chat");
  document.getElementById("settingsTab").classList.toggle("active",tab==="settings");
}

// ---------------- SETTINGS ----------------
function saveSettings(){
  const key = document.getElementById("apiKeyInput").value.trim();
  const model = document.getElementById("modelSelect").value;
  if(!key){ alert("API Key àª¨àª¾àª–à«‹"); return; }
  localStorage.setItem("API_KEY", key);
  localStorage.setItem("API_MODEL", model);
  alert("Settings àª¸àª¾àªšàªµàªµàª¾àª®àª¾àª‚ àª†àªµà«€ àª—àªˆ");
}

// ---------------- CHAT ----------------
let conversation = [{role:"system",content:"You are Devinity, intelligent female Gujarati assistant. Answer in Gujarati, natural text without *,;:, maintain context, analyze images/math/object info, handle diary and contacts."}];
let recognition; let listening=false; let autoListen=true; let lastSmartLensReport="";

// Voice recognition
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = "gu-IN"; recognition.continuous=false; recognition.interimResults=false;

  recognition.onresult = function(e){
    const text = e.results[0][0].transcript;
    addMessage(text,"user");

    // Contacts commands
    let contacts = JSON.parse(localStorage.getItem("contacts")||"[]");
    if(/Devinity\s*àª¨à«‡\s*call\s*(.+)/i.test(text)){
      const name=text.match(/Devinity\s*àª¨à«‡\s*call\s*(.+)/i)[1].trim();
      const c=contacts.find(c=>c.name.toLowerCase()===name.toLowerCase());
      if(c){ speakGujarati(`àª¹à«àª‚ ${c.name} àª¨à«‡ call àª•àª°àªµàª¾ àª¤à«ˆàª¯àª¾àª° àª›à«àª‚`); alert(`Call to ${c.name}: ${c.number}`); return; }
      else { speakGujarati(`${name} àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€`); return; }
    }
    if(/Devinity\s*àª¨à«‡\s*àª®à«‡àª¸à«‡àªœ\s*(.+)/i.test(text)){
      const name=text.match(/Devinity\s*àª¨à«‡\s*àª®à«‡àª¸à«‡àªœ\s*(.+)/i)[1].trim();
      const c=contacts.find(c=>c.name.toLowerCase()===name.toLowerCase());
      if(c){ speakGujarati(`àª¹à«àª‚ ${c.name} àª¨à«‡ àª®à«‡àª¸à«‡àªœ àª®à«‹àª•àª²àªµàª¾ àª¤à«ˆàª¯àª¾àª° àª›à«àª‚`); alert(`Message to ${c.name}: ${c.number}`); return; }
      else { speakGujarati(`${name} àª¸àª‚àªªàª°à«àª•àª®àª¾àª‚ àª¨àª¥à«€`); return; }
    }

    // Diary
    if(/àª¨à«‹àª‚àª§ àª•àª°\s*(.+)/i.test(text)){
      const note=text.match(/àª¨à«‹àª‚àª§ àª•àª°\s*(.+)/i)[1].trim();
      let diary = JSON.parse(localStorage.getItem("diary")||"[]");
      diary.push({date:new Date().toLocaleString(),note});
      localStorage.setItem("diary",JSON.stringify(diary));
      speakGujarati("àª¨à«‹àª‚àª§ àª•àª°à«€ àª²à«€àª§à«€");
      return;
    }

    conversation.push({role:"user",content:text});
    sendToAPI(text);
  };

  recognition.onend = ()=>{ listening=false; if(autoListen) setTimeout(()=>startListening(),200); }
  recognition.onerror = (e)=>{ console.log(e.error); listening=false; }
}

function startListening(){ if(!recognition){ alert("Browser support àª¨àª¥à«€"); return; } if(listening) return; recognition.start(); listening=true; }
function stopListening(){ autoListen=false; if(recognition && listening){ recognition.stop(); listening=false; } }

function addMessage(text,type){ const box=document.getElementById("chatBox"); const div=document.createElement("div"); div.className="message "+type; div.innerText=text; box.appendChild(div); box.scrollTop=box.scrollHeight; }

// ---------------- VOICE ----------------
function speakGujarati(text){
  text=text.replace(/[*;:]/g,'');
  const msg=new SpeechSynthesisUtterance(text);
  msg.lang="gu-IN"; msg.rate=1; msg.pitch=1;
  const voices=speechSynthesis.getVoices();
  const guFemale=voices.find(v=>v.lang.startsWith("gu") && v.name.toLowerCase().includes("female"));
  if(guFemale) msg.voice=guFemale;
  msg.onstart=()=>{ setAvatarState("talking"); }
  msg.onend=()=>{ setAvatarState("smiling"); if(autoListen) startListening(); }
  speechSynthesis.speak(msg);
}

// -------------------- SEND TO API ----------------
async function sendToAPI(userText,isSmartLens=false){
  setAvatarState("thinking");
  const key=localStorage.getItem("API_KEY");
  const model=localStorage.getItem("API_MODEL")||"gpt-4o-mini";
  if(!key){ alert("àªªàª¹à«‡àª²àª¾ Settings àª®àª¾àª‚ API Key àª¸à«‡àªŸ àª•àª°à«‹"); return; }
  try{
    const res = await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+key},
      body:JSON.stringify({model,temperature:0.6,messages:conversation})});
    const data=await res.json();
    const reply=data?.choices?.[0]?.message?.content || "àªœàªµàª¾àª¬ àª®àª³à«àª¯à«‹ àª¨àª¥à«€.";
    conversation.push({role:"assistant",content:reply});
    addMessage(reply,"bot");
    if(isSmartLens) lastSmartLensReport+=reply;
    setAvatarState("smiling");
    speakGujarati(reply);
  }catch(e){ addMessage("Error: "+e.message,"bot"); setAvatarState("smiling"); }
}

// -------------------- SMART LENS ----------------
function openCamera(){ openFileInput(true); }
function openGallery(){ openFileInput(false); }
function openFileInput(camera){
  const input=document.createElement('input'); input.type='file'; input.accept='image/*'; if(camera) input.capture='environment';
  input.onchange=processImage; input.click();
}
async function processImage(e){
  const file=e.target.files[0]; if(!file) return;
  addMessage("ğŸ“· Image selected, processing...","user");
  const {data:{text}}=await Tesseract.recognize(file,'eng+guj');
  const prompt=`Analyze the following content in Gujarati and provide detailed explanation, math solution, translation, or object info:\n${text}`;
  conversation.push({role:"user",content:prompt});
  lastSmartLensReport=`Image OCR Text:\n${text}\n\nAnalysis:\n`;
  document.getElementById("saveReportBtn").style.display="block";
  sendToAPI(prompt,true);
}
function saveReport(){ if(!lastSmartLensReport){ alert("No Smart Lens report"); return; } const blob=new Blob([lastSmartLensReport],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='SmartLensReport.txt'; a.click(); }

// -------------------- CONTACTS ----------------
function addContact(){
  const name=document.getElementById("contactName").value.trim();
  const number=document.getElementById("contactNumber").value.trim();
  if(!name||!number){ alert("Enter Name and Number"); return; }
  let contacts=JSON.parse(localStorage.getItem("contacts")||"[]"); contacts.push({name,number});
  localStorage.setItem("contacts",JSON.stringify(contacts));
  document.getElementById("contactName").value=""; document.getElementById("contactNumber").value="";
  updateContactList();
}
function updateContactList(){ const contacts=JSON.parse(localStorage.getItem("contacts")||"[]"); const listDiv=document.getElementById("contactList"); listDiv.innerHTML=""; contacts.forEach(c=>{ const div=document.createElement("div"); div.innerText=`${c.name} : ${c.number}`; listDiv.appendChild(div); }); }
updateContactList();

// -------------------- DIARY ----------------
function viewDiary(){ const diary=JSON.parse(localStorage.getItem("diary")||"[]"); if(diary.length===0){ alert("àª¡àª¾àª¯àª°à«€ àª–àª¾àª²à«€ àª›à«‡"); return; } let text=diary.map(d=>`${d.date}: ${d.note}`).join("\n\n"); alert(text); }
</script>

</body>
</html>
