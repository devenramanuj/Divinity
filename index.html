<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devinity Pro Fixed</title>
<style>
body{margin:0;font-family:system-ui;background:#f4f6f8;}
header{background:#2c3e90;color:#fff;padding:12px;text-align:center;font-size:18px;}
.topbar{display:flex;justify-content:space-between;background:#e9ecff;padding:8px;}
.icon-btn{background:none;border:none;font-size:22px;cursor:pointer;}
#chatBox{height:28vh;overflow-y:auto;padding:12px;background:#fff;}
.msg{margin-bottom:10px;}
.user{text-align:right;color:#2c3e90;}
.bot{text-align:left;color:#000;}
.controls{display:flex;gap:10px;padding:12px;}
.btn{flex:1;padding:10px;font-size:15px;border:none;color:#fff;border-radius:6px;cursor:pointer;transition:0.2s;}
.btn:hover{opacity:0.9;}
.green{background:#1e8449;}
.blue{background:#2980b9;}
.red{background:#c0392b;}
#settings{display:none;padding:12px;background:#f0f4ff;}
#settings h3{margin-bottom:8px;color:#2c3e90;}
.section{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
.section h4{margin-top:0;color:#1e8449;}
input,select,textarea{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:6px;}
#avatarContainer{position:relative;width:250px;height:250px;margin:auto;}
#avatarContainer video{width:100%;height:100%;object-fit:cover;border-radius:50%;position:absolute;top:0;left:0;transition:opacity 0.5s;}
#cameraStream{display:none;width:250px;height:250px;border-radius:8px;border:1px solid #ccc;}
</style>
</head>
<body>

<header>Devinity Pro Fixed</header>

<div class="topbar">
  <button class="icon-btn" onclick="showChat()">üí¨</button>
  <button class="icon-btn" onclick="showSettings()">‚öôÔ∏è</button>
</div>

<div id="avatarContainer">
  <video id="avatar1" autoplay muted loop style="opacity:1;"></video>
  <video id="avatar2" autoplay muted loop style="opacity:0;"></video>
  <video id="cameraStream" autoplay></video>
</div>

<div id="chat">
  <div id="chatBox"></div>
  <div class="controls">
    <button class="btn green" onclick="startListening()">üé§ ‡™¨‡´ã‡™≤‡´ã</button>
    <button class="btn red" onclick="stopListening()">‚èπÔ∏è</button>
  </div>
</div>

<div id="settings">
<h3>Settings</h3>
<input id="apiKey" placeholder="API Key">
<select id="model">
  <option value="gemini:gemini-2.5-flash">Gemini 2.5 Flash</option>
  <option value="groq:llama3-70b-8192">Groq 70B</option>
  <option value="openai:gpt-4o-mini">OpenAI GPT-4o Mini</option>
</select>
<button class="btn green" onclick="saveSettings()">Save</button>

<div class="section">
<h4>Smart Lens</h4>
<input type="file" accept="image/*" onchange="analyzeImage(this.files[0])">
<button class="btn blue" onclick="startCamera()">üì∑ Back Camera</button>
<button class="btn blue" onclick="capturePhoto()">Capture Photo</button>
<textarea id="lensResult" placeholder="Report will appear here"></textarea>
<button class="btn blue" onclick="saveReport()">Save PDF</button>
</div>

<div class="section">
<h4>Contacts</h4>
<input id="cName" placeholder="Name">
<input id="cNum" placeholder="Number">
<button class="btn blue" onclick="addContact()">Add</button>
</div>

<div class="section">
<h4>Diary</h4>
<button class="btn blue" onclick="viewDiary()">View Diary</button>
</div>
</div>

<script>
/* ---------------- VARIABLES ---------------- */
let recognition,isListening=false,currentAvatar=1;
const chatBox=document.getElementById("chatBox");
const settings=document.getElementById("settings");
const chat=document.getElementById("chat");
const apiKey=document.getElementById("apiKey");
const model=document.getElementById("model");
const avatarVideos=[document.getElementById("avatar1"),document.getElementById("avatar2")];
const cameraStream=document.getElementById("cameraStream");
const lensResult=document.getElementById("lensResult");
let cameraStreamObj=null;

/* ---------------- SETTINGS ---------------- */
apiKey.value=localStorage.getItem("apiKey")||"";
model.value=localStorage.getItem("model")||"gemini:gemini-2.5-flash";
function saveSettings(){localStorage.setItem("apiKey",apiKey.value.trim());localStorage.setItem("model",model.value);alert("Saved");}

/* ---------------- UI ---------------- */
function showSettings(){chat.style.display="none";settings.style.display="block";}
function showChat(){settings.style.display="none";chat.style.display="block";}
function addMsg(t,c){const d=document.createElement("div");d.className="msg "+c;d.innerText=t;chatBox.appendChild(d);chatBox.scrollTop=chatBox.scrollHeight;}

/* ---------------- AVATAR CROSSFADE ---------------- */
function switchVideoSmooth(state){
  const srcMap={smiling:"mp4/smiling.mp4",thinking:"mp4/thinking.mp4",talking:"mp4/talking.mp4",silent:"mp4/silent.mp4"};
  const nextVid=avatarVideos[1-currentAvatar];
  nextVid.src=srcMap[state]; nextVid.currentTime=0; nextVid.style.opacity=0; nextVid.play();
  setTimeout(()=>{nextVid.style.opacity=1; avatarVideos[currentAvatar].style.opacity=0;},50);
  setTimeout(()=>{avatarVideos[currentAvatar].pause(); currentAvatar=1-currentAvatar;},600);
}

/* ---------------- SPEECH ---------------- */
if("webkitSpeechRecognition"in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang="gu-IN"; recognition.continuous=false; recognition.interimResults=false;
  recognition.onstart=()=>{isListening=true;switchVideoSmooth("silent");}
  recognition.onresult=e=>{const t=e.results[0][0].transcript;addMsg(t,"user");processCommand(t);}
  recognition.onend=()=>{isListening=false;switchVideoSmooth("smiling");}
}
function startListening(){if(!recognition||isListening)return;recognition.start();}
function stopListening(){if(recognition&&isListening){recognition.stop();}}

/* ---------------- COMMANDS ---------------- */
function processCommand(text){
  switchVideoSmooth("thinking");
  if(text.startsWith("‡™®‡´ã‡™Ç‡™ß")||text.startsWith("‡™°‡™æ‡™Ø‡™∞‡´Ä")){
    const content=text.replace(/‡™®‡´ã‡™Ç‡™ß ‡™ï‡™∞|‡™®‡´ã‡™Ç‡™ß ‡™ï‡™∞‡´Ä|‡™°‡™æ‡™Ø‡™∞‡´Ä ‡™Æ‡™æ‡™Ç ‡™≤‡™ñ|‡™≤‡™ñ‡´Ä ‡™≤‡´á/g,"").trim();
    saveDiary(content); return;
  }
  if(text.includes("call")){handleCall(text);return;}
  askBot(text);
}

/* ---------------- BOT ---------------- */
async function askBot(text){
  const key=localStorage.getItem("apiKey"); if(!key){addMsg("API key ‡™∏‡´á‡™ü ‡™®‡™•‡´Ä.","bot");return;}
  const [provider,modelName]=localStorage.getItem("model").split(":");
  try{
    let reply="";
    if(provider==="openai"){
      const r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:"Bearer "+key,"Content-Type":"application/json"},body:JSON.stringify({model:modelName,messages:[{role:"system",content:"You are Devinity, Gujarati female assistant. Reply only in Gujarati. No symbols."},{role:"user",content:text}]})});
      const j=await r.json(); reply=j.choices?.[0]?.message?.content;
    }
    if(provider==="groq"){
      const r=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:"Bearer "+key,"Content-Type":"application/json"},body:JSON.stringify({model:modelName,messages:[{role:"system",content:"Reply only in Gujarati as a female assistant."},{role:"user",content:text}]})});
      const j=await r.json(); reply=j.choices?.[0]?.message?.content;
    }
    if(provider==="gemini"){
      const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:"You are Devinity, Gujarati female assistant. Reply Gujarati only. "+text}]}]})});
      const j=await r.json(); reply=j.candidates?.[0]?.content?.parts?.[0]?.text;
    }
    if(!reply){addMsg("‡™ú‡™µ‡™æ‡™¨ ‡™Æ‡™≥‡´ç‡™Ø‡´ã ‡™®‡™•‡´Ä.","bot");return;}
    addMsg(reply,"bot"); stopListening(); speak(reply);
  }catch(e){console.error(e);addMsg("API error ‡™•‡™Ø‡´ã.","bot");}
}

/* ---------------- SPEAK ---------------- */
function speak(t){const u=new SpeechSynthesisUtterance(t);u.lang="gu-IN";u.onstart=()=>switchVideoSmooth("talking"); u.onend=()=>switchVideoSmooth("smiling"); speechSynthesis.speak(u);}

/* ---------------- SMART LENS ---------------- */
async function analyzeImage(file){
  const reader=new FileReader();
  reader.onload=async ()=>{
    const key=localStorage.getItem("apiKey");
    if(!key){alert("API Key set ‡™ï‡™∞‡´ã"); return;}
    const base64 = reader.result.split(",")[1];
    try{
      const prompt = "‡™Ü ‡™´‡´ã‡™ü‡´ã ‡™µ‡™ø‡™∑‡´á ‡™µ‡™ø‡™ó‡™§‡™µ‡™æ‡™∞ ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä ‡™∞‡™ø‡™™‡´ã‡™∞‡´ç‡™ü ‡™Ü‡™™‡´ã: "+base64;
      const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
      });
      const j = await r.json();
      lensResult.value = j.candidates?.[0]?.content?.parts?.[0]?.text || "‡™ú‡™µ‡™æ‡™¨ ‡™Æ‡™≥‡´ç‡™Ø‡´ã ‡™®‡™•‡´Ä";
    } catch(e){console.error(e); lensResult.value="Error processing image";}
  };
  reader.readAsDataURL(file);
}

async function startCamera(){
  try{
    const constraints = { video: { facingMode: { exact: "environment" } } };
    cameraStreamObj = await navigator.mediaDevices.getUserMedia(constraints);
    cameraStream.srcObject = cameraStreamObj;
    cameraStream.style.display="block";
    await cameraStream.play();
  } catch(e){
    // fallback
    try{
      cameraStreamObj = await navigator.mediaDevices.getUserMedia({video:true});
      cameraStream.srcObject = cameraStreamObj;
      cameraStream.style.display="block";
      await cameraStream.play();
    } catch(err){alert("Camera access denied / unsupported"); console.error(err);}
  }
}

function capturePhoto(){
  if(!cameraStreamObj){alert("Camera not started"); return;}
  const c=document.createElement("canvas");
  c.width=cameraStream.videoWidth;
  c.height=cameraStream.videoHeight;
  c.getContext("2d").drawImage(cameraStream,0,0,c.width,c.height);
  lensResult.value="Processing...";
  analyzeImageDataURL(c.toDataURL("image/jpeg"));
}

async function analyzeImageDataURL(dataURL){analyzeImage({name:"captured.jpg", dataURL});}

/* ---------------- SAVE PDF ---------------- */
function saveReport(){
  const pdfContent=`Devinity Report\n\n${lensResult.value}\n\nDiary Entries:\n${JSON.stringify(JSON.parse(localStorage.getItem("diary")||"[]"),null,2)}`;
  const blob=new Blob([pdfContent],{type:"application/pdf"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Devinity_Report.pdf"; a.click();
}

/* ---------------- CONTACTS ---------------- */
function addContact(){
  const name=document.getElementById("cName").value.trim();
  const number=document.getElementById("cNum").value.trim();
  if(!name||!number){alert("Name ‡™Ö‡™®‡´á Number ‡™≠‡™∞‡™µ‡´Å‡™Ç ‡™ú‡™∞‡´Ç‡™∞‡´Ä ‡™õ‡´á"); return;}
  const contacts=JSON.parse(localStorage.getItem("contacts")||"[]");
  if(contacts.some(c=>c.name===name)){alert("‡™Ü ‡™®‡™æ‡™Æ ‡™™‡™π‡´á‡™≤‡´á‡™•‡´Ä save ‡™õ‡´á"); return;}
  contacts.push({name,number});
  localStorage.setItem("contacts",JSON.stringify(contacts));
  alert("Contact saved");
  document.getElementById("cName").value="";
  document.getElementById("cNum").value="";
}

function handleCall(text){
  const name=text.split("call")[1]?.trim();
  const contacts=JSON.parse(localStorage.getItem("contacts")||"[]");
  const contact=contacts.find(c=>c.name===name);
  if(contact){addMsg(name+" ‡™®‡´á ‡™ï‡´ã‡™≤ ‡™ï‡™∞‡´Ä ‡™∞‡™π‡´Ä ‡™õ‡´Å‡™Ç","bot"); window.location.href="tel:"+contact.number;}
  else addMsg("‡™Ü ‡™®‡™æ‡™Æ‡™®‡´ã ‡™∏‡™Ç‡™™‡™∞‡´ç‡™ï ‡™Æ‡™≥‡´ç‡™Ø‡´ã ‡™®‡™•‡´Ä","bot");
}

/* ---------------- DIARY ---------------- */
function saveDiary(content){
  if(!content){addMsg("‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™®‡´ã‡™Ç‡™ß ‡™∂‡´Å‡™Ç ‡™ï‡™∞‡™µ‡´Ä ‡™õ‡´á ‡™§‡´á ‡™¨‡´ã‡™≤‡´ã","bot"); return;}
  const d=JSON.parse(localStorage.getItem("diary")||"[]");
  d.push({time:new Date().toLocaleString(),text:content});
  localStorage.setItem("diary",JSON.stringify(d));
  addMsg("‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™®‡´ã‡™Ç‡™ß ‡™∏‡´á‡™µ ‡™ï‡™∞‡´Ä ‡™≤‡´Ä‡™ß‡´Ä ‡™õ‡´á","bot");
}

function viewDiary(){
  const d=JSON.parse(localStorage.getItem("diary")||"[]");
  if(d.length===0){alert("‡™ï‡´ã‡™à ‡™®‡´ã‡™Ç‡™ß ‡™â‡™™‡™≤‡™¨‡´ç‡™ß ‡™®‡™•‡´Ä"); return;}
  alert(d.map(x=>x.time+" : "+x.text).join("\n\n"));
}
</script>
</body>
</html>
