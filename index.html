<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devinity Pro Persistent</title>
<style>
body{margin:0;font-family:system-ui;background:#f4f6f8;}
header{background:#2c3e90;color:#fff;padding:12px;text-align:center;font-size:18px;}
.topbar{display:flex;justify-content:space-between;background:#e9ecff;padding:8px;}
.icon-btn{background:none;border:none;font-size:22px;cursor:pointer;}
#chatBox{height:28vh;overflow-y:auto;padding:12px;background:#fff;}
.msg{margin-bottom:10px;}
.user{text-align:right;color:#2c3e90;}
.bot{text-align:left;color:#000;}
.controls{display:flex;gap:10px;padding:12px;}
.btn{flex:1;padding:10px;font-size:15px;border:none;color:#fff;border-radius:6px;cursor:pointer;transition:0.2s;}
.btn:hover{opacity:0.9;}
.green{background:#1e8449;}
.blue{background:#2980b9;}
.red{background:#c0392b;}
#settings{display:none;padding:12px;background:#f0f4ff;}
#settings h3{margin-bottom:8px;color:#2c3e90;}
.section{background:#fff;padding:12px;border-radius:8px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.1);}
.section h4{margin-top:0;color:#1e8449;}
input,select,textarea{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:6px;}
#avatarContainer{position:relative;width:250px;height:250px;margin:auto;}
#avatarContainer video{width:100%;height:100%;object-fit:cover;border-radius:50%;position:absolute;top:0;left:0;transition:opacity 0.5s;}
#cameraStream{display:none;width:250px;height:250px;border-radius:8px;border:1px solid #ccc;}
</style>
</head>
<body>

<header>Devinity Pro Persistent</header>

<div class="topbar">
  <button class="icon-btn" onclick="showChat()">üí¨</button>
  <button class="icon-btn" onclick="showSettings()">‚öôÔ∏è</button>
</div>

<div id="avatarContainer">
  <video id="avatar1" autoplay muted loop style="opacity:1;"></video>
  <video id="avatar2" autoplay muted loop style="opacity:0;"></video>
  <video id="cameraStream" autoplay></video>
</div>

<div id="chat">
  <div id="chatBox"></div>
  <div class="controls">
    <button class="btn green" onclick="startListening()">üé§ ‡™¨‡´ã‡™≤‡´ã</button>
    <button class="btn red" onclick="stopListening()">‚èπÔ∏è</button>
  </div>
</div>

<div id="settings">
<h3>Settings</h3>
<input id="apiKey" placeholder="API Key">
<select id="model">
  <option value="gemini:gemini-2.5-flash">Gemini 2.5 Flash</option>
  <option value="groq:llama3-70b-8192">Groq 70B</option>
  <option value="openai:gpt-4o-mini">OpenAI GPT-4o Mini</option>
</select>
<button class="btn green" onclick="saveSettings()">Save</button>

<div class="section">
<h4>Smart Lens</h4>
<input type="file" accept="image/*" onchange="analyzeImage(this.files[0])">
<button class="btn blue" onclick="startCamera()">üì∑ Back Camera</button>
<button class="btn blue" onclick="capturePhoto()">Capture Photo</button>
<textarea id="lensResult" placeholder="Report will appear here"></textarea>
<button class="btn blue" onclick="saveReport()">Save PDF</button>
</div>

<div class="section">
<h4>Contacts</h4>
<input id="cName" placeholder="Name">
<input id="cNum" placeholder="Number">
<button class="btn blue" onclick="addContact()">Add</button>
</div>

<div class="section">
<h4>Diary</h4>
<button class="btn blue" onclick="viewDiary()">View Diary</button>
</div>
</div>

<script>
let recognition,isListening=false,currentAvatar=1;
const chatBox=document.getElementById("chatBox");
const settings=document.getElementById("settings");
const chat=document.getElementById("chat");
const apiKey=document.getElementById("apiKey");
const model=document.getElementById("model");
const avatarVideos=[document.getElementById("avatar1"),document.getElementById("avatar2")];
const cameraStream=document.getElementById("cameraStream");
const lensResult=document.getElementById("lensResult");
let cameraStreamObj=null;

// ---------- IndexedDB Setup ----------
let db;
const request = indexedDB.open("DevinityDB",1);
request.onupgradeneeded = e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains("diary")) db.createObjectStore("diary",{keyPath:"time"});
  if(!db.objectStoreNames.contains("contacts")) db.createObjectStore("contacts",{keyPath:"name"});
  if(!db.objectStoreNames.contains("reports")) db.createObjectStore("reports",{keyPath:"id"});
};
request.onsuccess = e=>{db=e.target.result; console.log("DB ready");}

// ---------- Settings ----------
apiKey.value=localStorage.getItem("apiKey")||"";
model.value=localStorage.getItem("model")||"gemini:gemini-2.5-flash";
function saveSettings(){localStorage.setItem("apiKey",apiKey.value.trim());localStorage.setItem("model",model.value);alert("Saved");}

// ---------- UI ----------
function showSettings(){chat.style.display="none";settings.style.display="block";}
function showChat(){settings.style.display="none";chat.style.display="block";}
function addMsg(t,c){const d=document.createElement("div");d.className="msg "+c;d.innerText=t;chatBox.appendChild(d);chatBox.scrollTop=chatBox.scrollHeight;}
function switchVideoSmooth(state){
  const srcMap={smiling:"mp4/smiling.mp4",thinking:"mp4/thinking.mp4",talking:"mp4/talking.mp4",silent:"mp4/silent.mp4"};
  const nextVid=avatarVideos[1-currentAvatar];
  nextVid.src=srcMap[state]; nextVid.currentTime=0; nextVid.style.opacity=0; nextVid.play();
  setTimeout(()=>{nextVid.style.opacity=1; avatarVideos[currentAvatar].style.opacity=0;},50);
  setTimeout(()=>{avatarVideos[currentAvatar].pause(); currentAvatar=1-currentAvatar;},600);
}

// ---------- Speech Recognition ----------
if("webkitSpeechRecognition"in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang="gu-IN"; recognition.continuous=false; recognition.interimResults=false;
  recognition.onstart=()=>{isListening=true;switchVideoSmooth("silent");}
  recognition.onresult=e=>{const t=e.results[0][0].transcript;addMsg(t,"user");processCommand(t);}
  recognition.onend=()=>{isListening=false;switchVideoSmooth("smiling");}
}
function startListening(){if(!recognition||isListening)return;recognition.start();}
function stopListening(){if(recognition&&isListening){recognition.stop();}}

function processCommand(text){
  switchVideoSmooth("thinking");
  if(text.startsWith("‡™®‡´ã‡™Ç‡™ß")||text.startsWith("‡™°‡™æ‡™Ø‡™∞‡´Ä")){
    const content=text.replace(/‡™®‡´ã‡™Ç‡™ß ‡™ï‡™∞|‡™®‡´ã‡™Ç‡™ß ‡™ï‡™∞‡´Ä|‡™°‡™æ‡™Ø‡™∞‡´Ä ‡™Æ‡™æ‡™Ç ‡™≤‡™ñ|‡™≤‡™ñ‡´Ä ‡™≤‡´á/g,"").trim();
    saveDiary(content); return;
  }
  if(text.includes("call")){handleCall(text);return;}
  askBot(text);
}

// ---------- Bot Request ----------
async function askBot(text){
  const key=localStorage.getItem("apiKey"); if(!key){addMsg("API key ‡™∏‡´á‡™ü ‡™®‡™•‡´Ä.","bot");return;}
  const [provider,modelName]=localStorage.getItem("model").split(":");
  try{
    let reply="";
    if(provider==="gemini"){
      const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({contents:[{parts:[{text:"You are Devinity, Gujarati female assistant. Reply Gujarati only. "+text}]}]})
      });
      const j=await r.json(); reply=j.candidates?.[0]?.content?.parts?.[0]?.text;
    }
    addMsg(reply||"‡™ú‡™µ‡™æ‡™¨ ‡™Æ‡™≥‡´ç‡™Ø‡´ã ‡™®‡™•‡´Ä","bot"); stopListening(); speak(reply);
  }catch(e){console.error(e);addMsg("API error ‡™•‡™Ø‡´ã.","bot");}
}

function speak(t){const u=new SpeechSynthesisUtterance(t);u.lang="gu-IN";u.onstart=()=>switchVideoSmooth("talking"); u.onend=()=>switchVideoSmooth("smiling"); speechSynthesis.speak(u);}

// ---------- Smart Lens ----------
async function analyzeImage(file){
  const reader=new FileReader();
  reader.onload = async () => {
    const key = localStorage.getItem("apiKey"); if(!key){alert("API Key set ‡™ï‡™∞‡´ã"); return;}
    const img = new Image(); img.src=reader.result;
    img.onload = async ()=>{
      const canvas=document.createElement("canvas"); const maxSize=400;
      let w=img.width,h=img.height;
      if(w>h && w>maxSize){h=h*maxSize/w; w=maxSize;} else if(h>w && h>maxSize){w=w*maxSize/h; h=maxSize;}
      canvas.width=w; canvas.height=h; canvas.getContext("2d").drawImage(img,0,0,w,h);
      const smallBase64=canvas.toDataURL("image/jpeg").split(",")[1];
      lensResult.value="Processing...";
      try{
        const prompt="‡™Ü ‡™´‡´ã‡™ü‡´ã ‡™µ‡™ø‡™∑‡´á ‡™µ‡™ø‡™ó‡™§‡™µ‡™æ‡™∞ ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä ‡™∞‡™ø‡™™‡´ã‡™∞‡´ç‡™ü ‡™Ü‡™™‡´ã. ‡™ú‡´ã ‡™™‡´ç‡™∞‡™æ‡™ö‡´Ä‡™® ‡™∂‡™ø‡™≤‡™æ‡™≤‡´á‡™ñ / ‡™≤‡™ø‡™™‡™ø ‡™π‡´ã‡™Ø ‡™§‡´ã ‡™µ‡™ø‡™∂‡´ç‡™≤‡´á‡™∑‡™£ ‡™™‡™£ ‡™Ü‡™™‡´ã: "+smallBase64;
        const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,{
          method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
        });
        const j=await r.json();
        const report = j.candidates?.[0]?.content?.parts?.[0]?.text || "‡™ú‡™µ‡™æ‡™¨ ‡™Æ‡™≥‡´ç‡™Ø‡´ã ‡™®‡™•‡´Ä";
        lensResult.value = report;
        saveReportIndexedDB(report);
      }catch(e){console.error(e); lensResult.value="Error processing image";}
    }
  };
  reader.readAsDataURL(file);
}

async function startCamera(){try{
  const constraints={video:{facingMode:{exact:"environment"}}};
  cameraStreamObj=await navigator.mediaDevices.getUserMedia(constraints);
  cameraStream.srcObject=cameraStreamObj; cameraStream.style.display="block"; await cameraStream.play();
}catch(e){try{cameraStreamObj=await navigator.mediaDevices.getUserMedia({video:true});
  cameraStream.srcObject=cameraStreamObj; cameraStream.style.display="block"; await cameraStream.play();
}catch(err){alert("Camera access denied/unsupported"); console.error(err);}}}

function capturePhoto(){
  if(!cameraStreamObj){alert("Camera not started"); return;}
  const c=document.createElement("canvas"); c.width=cameraStream.videoWidth; c.height=cameraStream.videoHeight;
  c.getContext("2d").drawImage(cameraStream,0,0,c.width,c.height);
  lensResult.value="Processing...";
  analyzeImage({name:"captured.jpg", dataURL:c.toDataURL("image/jpeg")});
}

function saveReport(){ // manual save as PDF
  const pdfContent=`Devinity Report\n\n${lensResult.value}\n\nDiary Entries:\n${JSON.stringify([],null,2)}`;
  const blob=new Blob([pdfContent],{type:"application/pdf"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="Devinity_Report.pdf"; a.click();
}

function saveReportIndexedDB(report){
  const tx = db.transaction("reports","readwrite"); const store=tx.objectStore("reports");
  store.put({id:new Date().toISOString(), text:report});
}

// ---------- Contacts ----------
function addContact(){
  const name=document.getElementById("cName").value.trim();
  const number=document.getElementById("cNum").value.trim();
  if(!name||!number){alert("Name ‡™Ö‡™®‡´á Number ‡™≠‡™∞‡™µ‡´Å‡™Ç ‡™ú‡™∞‡´Ç‡™∞‡´Ä ‡™õ‡´á"); return;}
  const tx=db.transaction("contacts","readwrite"); const store=tx.objectStore("contacts");
  store.put({name,number}); alert("Contact saved persistently"); document.getElementById("cName").value=""; document.getElementById("cNum").value="";
}

function handleCall(text){
  const name = text.split("call")[1]?.trim();
  const tx=db.transaction("contacts","readonly"); const store=tx.objectStore("contacts");
  const req = store.get(name);
  req.onsuccess = e => {
    const contact = e.target.result;
    if(contact){
      addMsg(name+" ‡™®‡´á ‡™ï‡´ã‡™≤ ‡™ï‡™∞‡´Ä ‡™∞‡™π‡´Ä ‡™õ‡´Å‡™Ç","bot");
      const a = document.createElement("a");
      a.href = "tel:" + contact.number;
      a.style.display="none";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } else addMsg("‡™Ü ‡™®‡™æ‡™Æ‡™®‡´ã ‡™∏‡™Ç‡™™‡™∞‡´ç‡™ï ‡™Æ‡™≥‡´ç‡™Ø‡´ã ‡™®‡™•‡´Ä","bot");
  }
}

// ---------- Diary ----------
function saveDiary(content){
  if(!content){addMsg("‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™®‡´ã‡™Ç‡™ß ‡™∂‡´Å‡™Ç ‡™ï‡™∞‡™µ‡´Ä ‡™õ‡´á ‡™§‡´á ‡™¨‡´ã‡™≤‡´ã","bot"); return;}
  const tx=db.transaction("diary","readwrite"); const store=tx.objectStore("diary");
  const entry={time:new Date().toISOString(), text:content}; store.put(entry); addMsg("‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™®‡´ã‡™Ç‡™ß ‡™∏‡´á‡™µ ‡™ï‡™∞‡´Ä ‡™≤‡´Ä‡™ß‡´Ä ‡™õ‡´á","bot");
}

function viewDiary(){
  const tx=db.transaction("diary","readonly"); const store=tx.objectStore("diary");
  const req = store.getAll(); req.onsuccess=e=>{
    const entries=e.target.result;
    if(entries.length===0){alert("‡™ï‡´ã‡™à ‡™®‡´ã‡™Ç‡™ß ‡™â‡™™‡™≤‡™¨‡´ç‡™ß ‡™®‡™•‡´Ä"); return;}
    alert(entries.map(x=>x.time+" : "+x.text).join("\n\n"));
  };
}
</script>
</body>
</html>
