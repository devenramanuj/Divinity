<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Divinity AI - ркЬркп рк╕рлАркпрк╛рк░рк╛рко</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #f43f5e; 
            --glass: rgba(0, 0, 0, 0.9);
            --saffron: #FF9933;
            --green: #138808;
            --pink: #ec4899;
            --purple: #8b5cf6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body, html { 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }
        
        #mainVideo { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: 1; 
        }
        
        .ui-layer { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        /* Top Status Bar */
        .status-bar {
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        
        #status { 
            color: var(--pink); 
            font-size: 16px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .setting-icon {
            font-size: 24px; 
            color: var(--pink); 
            cursor: pointer;
            background: rgba(0,0,0,0.7);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .setting-icon:hover, .setting-icon:active {
            background: rgba(0,0,0,0.9);
            transform: rotate(45deg);
        }
        
        /* Bottom Controls */
        .bottom-controls {
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }
        
        .controls { 
            display: flex; 
            align-items: center; 
            gap: 30px; 
            background: rgba(0,0,0,0.85); 
            padding: 15px 30px; 
            border-radius: 50px; 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 250px;
            justify-content: center;
        }
        
        .btn-mic { 
            width: 80px; 
            height: 80px; 
            background: linear-gradient(135deg, var(--pink), var(--purple)); 
            border: none; 
            border-radius: 50%; 
            font-size: 28px; 
            cursor: pointer; 
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(236, 72, 153, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-mic:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.4);
        }
        
        .btn-mic.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #ef4444, var(--pink));
        }
        
        .btn-stop { 
            width: 60px; 
            height: 60px; 
            background: #ef4444; 
            border: none; 
            border-radius: 50%; 
            color: #fff; 
            cursor: pointer; 
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-stop:active {
            transform: scale(0.95);
            background: #dc2626;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .quick-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-btn:active {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }
        
        /* Modal Styles */
        #settingsModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.97); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-card { 
            background: #1e293b; 
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            padding: 25px; 
            border-radius: 20px; 
            border: 2px solid var(--pink); 
            color: #fff; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            overflow-y: auto;
        }
        
        .modal-title {
            text-align: center;
            color: var(--pink);
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            color: #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: var(--pink);
            color: white;
            border-color: var(--pink);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            margin-top: 8px; 
            margin-bottom: 15px;
            background: #0f172a; 
            border: 1px solid #334155; 
            color: #34d399; 
            border-radius: 12px; 
            font-size: 16px;
            font-family: inherit;
        }
        
        label {
            color: #cbd5e1;
            font-size: 14px;
            margin-left: 5px;
            display: block;
            margin-bottom: 5px;
        }
        
        #camBox { 
            width: 100%; 
            height: 200px; 
            background: #000; 
            border-radius: 15px; 
            margin-top: 15px; 
            margin-bottom: 15px;
            display: none; 
            border: 2px solid var(--pink); 
            overflow: hidden; 
            position: relative; 
        }
        
        #videoFeed { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .modal-button {
            width: 100%; 
            padding: 15px; 
            margin-top: 10px; 
            background: linear-gradient(135deg, var(--purple), var(--pink)); 
            color: #fff; 
            border-radius: 12px; 
            font-weight: bold;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-button:active {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(139, 92, 246, 0.4);
        }
        
        .close-btn {
            text-align: center; 
            color: #ef4444; 
            cursor: pointer; 
            margin-top: 20px;
            font-weight: bold;
            padding: 10px;
        }
        
        .close-btn:active {
            color: #dc2626;
        }
        
        /* Diary Styles */
        .diary-entry {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .diary-date {
            color: var(--pink);
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .diary-content {
            color: #e2e8f0;
            line-height: 1.5;
        }
        
        /* Vanshavali Styles */
        .family-tree {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            overflow-x: auto;
            min-height: 200px;
        }
        
        .tree-node {
            margin-left: 20px;
            margin-top: 10px;
            position: relative;
        }
        
        .tree-node:before {
            content: "";
            position: absolute;
            left: -15px;
            top: 10px;
            width: 15px;
            height: 1px;
            background: var(--pink);
        }
        
        .tree-node:after {
            content: "";
            position: absolute;
            left: -15px;
            top: 0;
            width: 1px;
            height: 100%;
            background: var(--pink);
        }
        
        .tree-node:last-child:after {
            height: 10px;
        }
        
        .member-name {
            color: var(--green);
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .member-info {
            color: #cbd5e1;
            font-size: 13px;
            font-style: italic;
        }
        
        /* Loading Overlay */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000428, #004e92);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }
        
        .welcome-text {
            color: var(--pink);
            margin-bottom: 10px;
            animation: fadeIn 2s ease;
            text-align: center;
            padding: 0 20px;
            font-size: 32px;
            font-weight: bold;
        }
        
        .subtitle {
            font-size: 18px; 
            color: #ccc; 
            text-align: center; 
            padding: 0 20px;
            margin-bottom: 30px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .controls {
                gap: 25px;
                padding: 15px 25px;
            }
            
            .btn-mic {
                width: 70px;
                height: 70px;
                font-size: 26px;
            }
            
            .btn-stop {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
            
            #status {
                font-size: 14px;
                padding: 8px 16px;
                max-width: 65%;
            }
            
            .setting-icon {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }
            
            .modal-card {
                padding: 20px;
                border-radius: 15px;
            }
            
            .modal-title {
                font-size: 20px;
            }
            
            .quick-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .welcome-text {
                font-size: 28px;
            }
        }
        
        @media (max-width: 360px) {
            .controls {
                gap: 20px;
                padding: 12px 20px;
            }
            
            .btn-mic {
                width: 65px;
                height: 65px;
                font-size: 24px;
            }
            
            .btn-stop {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .quick-actions {
                gap: 10px;
            }
        }
        
        /* Landscape Mode */
        @media (orientation: landscape) and (max-height: 500px) {
            .bottom-controls {
                padding: 10px 20px;
                gap: 10px;
            }
            
            .controls {
                padding: 10px 20px;
            }
            
            .btn-mic, .btn-stop {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            #status {
                font-size: 14px;
                padding: 6px 12px;
            }
            
            .quick-actions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <video id="mainVideo" autoplay loop muted playsinline>
        <source src="silent.mp4" type="video/mp4">
    </video>
    
    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-text">Divinity AI</div>
        <div class="subtitle">ркдркорк╛рк░рлА рк╡рлНркпркХрлНркдрк┐ркЧркд рк╕рк╣рк╛ркпркХ</div>
        <div style="font-size: 16px; color: #aaa; text-align: center; padding: 0 20px; margin-top: 20px;">
            рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ... тП│
        </div>
    </div>

    <div class="ui-layer">
        <!-- Top Status Bar -->
        <div class="status-bar">
            <div id="status">ЁЯС╕ Divinity ркдрлИркпрк╛рк░ ркЫрлЗ</div>
            <div class="setting-icon" onclick="toggleModal('settingsModal')">
                <i class="fas fa-cog"></i>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-btn" onclick="quickAction('openSettings')">
                <i class="fas fa-cog"></i> рк╕рлЗркЯрк┐ркВркЧрлНрк╕
            </button>
            <button class="quick-btn" onclick="startInteraction()">
                <i class="fas fa-microphone"></i> ркмрлЛрк▓рлЛ
            </button>
        </div>
        
        <!-- Bottom Controls -->
        <div class="bottom-controls">
            <div class="controls">
                <button class="btn-stop" onclick="stopEverything()" title="ркмркВркз ркХрк░рлЛ">
                    <i class="fas fa-stop"></i>
                </button>
                <button id="micBtn" class="btn-mic" onclick="startInteraction()" title="ркмрлЛрк▓рлЛ">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal">
        <div class="modal-card">
            <div class="modal-title">ЁЯСС Divinity рк╕рлЗркЯрк┐ркВркЧрлНрк╕</div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('aiTab')">AI рк╕рлЗркЯрк┐ркВркЧрлНрк╕</button>
                <button class="tab-btn" onclick="switchTab('diaryTab')">ркбрк╛ркпрк░рлА</button>
                <button class="tab-btn" onclick="switchTab('vanshavaliTab')">рк╡ркВрк╢рк╛рк╡рк│рлА</button>
                <button class="tab-btn" onclick="switchTab('cameraTab')">ркХрлЕркорлЗрк░рк╛</button>
            </div>
            
            <!-- AI Settings Tab -->
            <div id="aiTab" class="tab-content active">
                <label for="activeModel">AI ркорлЛркбрк▓ рккрк╕ркВркж ркХрк░рлЛ</label>
                <select id="activeModel">
                    <option value="groq">Groq Llama 3 (70B)</option>
                    <option value="gemini">Gemini 2.0 Flash</option>
                </select>
                
                <label for="geminiKeys">Gemini API ркХрлА (ркХрлЛркорк╛ рк╡ркбрлЗ ркЕрк▓ркЧ)</label>
                <textarea id="geminiKeys" rows="2" placeholder="AIzaSy..."></textarea>
                
                <label for="groqKey">Groq API ркХрлА</label>
                <input type="password" id="groqKey" placeholder="gsk_...">
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <h4 style="color: var(--pink); margin-bottom: 10px;">ЁЯУЭ API ркХрлА ркорлЗрк│рк╡рлЛ</h4>
                    <p style="color: #94a3b8; font-size: 13px; line-height: 1.4;">
                        1. <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #60a5fa;">Google AI Studio</a> ркерлА Gemini API ркХрлА<br>
                        2. <a href="https://console.groq.com/keys" target="_blank" style="color: #60a5fa;">Groq Console</a> ркерлА Groq API ркХрлА
                    </p>
                </div>
                
                <button class="modal-button" onclick="saveConfig()">
                    <i class="fas fa-save"></i> ркмркзрлБркВ рк╕ркВркЧрлНрк░рк╣рлЛ
                </button>
            </div>
            
            <!-- Diary Tab -->
            <div id="diaryTab" class="tab-content">
                <h3 style="color: var(--pink); margin-bottom: 15px; text-align: center;">ЁЯУЦ ркорк╛рк░рлА ркбрк╛ркпрк░рлА</h3>
                
                <div style="margin-bottom: 20px;">
                    <label for="newDiaryEntry">ркирк╡рлА ркирлЛркВркз ркЙркорлЗрк░рлЛ</label>
                    <textarea id="newDiaryEntry" rows="4" placeholder="ркЖркЬрлЗ ркорлЗркВ рк╢рлБркВ ркХрк░рлНркпрлБркВ?"></textarea>
                    <button class="modal-button" onclick="addDiaryEntry()" style="background: linear-gradient(135deg, var(--green), #10b981);">
                        <i class="fas fa-plus"></i> ркирлЛркВркз ркЙркорлЗрк░рлЛ
                    </button>
                </div>
                
                <div id="diaryEntries">
                    <!-- Diary entries will be loaded here -->
                </div>
            </div>
            
            <!-- Vanshavali Tab -->
            <div id="vanshavaliTab" class="tab-content">
                <h3 style="color: var(--pink); margin-bottom: 15px; text-align: center;">ЁЯМ│ рк╡ркВрк╢рк╛рк╡рк│рлА</h3>
                
                <div id="familyTreeDisplay" class="family-tree">
                    <!-- Family tree will be loaded here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <label for="newMemberName">ркирк╡рк╛ рк╕ркнрлНркпркирлБркВ ркирк╛рко</label>
                    <input type="text" id="newMemberName" placeholder="рк╕ркнрлНркпркирлБркВ ркирк╛рко">
                    
                    <label for="newMemberInfo">рк╡рк┐ркЧркдрлЛ</label>
                    <input type="text" id="newMemberInfo" placeholder="ркЬркирлНрко, рк╕ркВркмркВркз, рк╡ркЧрлЗрк░рлЗ">
                    
                    <label for="parentMember">ркорк╛ркдрк╛-рккрк┐ркдрк╛/рк╕ркВркмркВркзрк┐ркд рк╕ркнрлНркп</label>
                    <select id="parentMember">
                        <option value="root">ркорлБркЦрлНркп (рк░рлБркЯ)</option>
                    </select>
                    
                    <button class="modal-button" onclick="addFamilyMember()" style="background: linear-gradient(135deg, #8b5cf6, var(--saffron)); margin-top: 15px;">
                        <i class="fas fa-user-plus"></i> рк╕ркнрлНркп ркЙркорлЗрк░рлЛ
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="modal-button" onclick="exportVanshavali()" style="flex: 1; background: linear-gradient(135deg, #10b981, #3b82f6);">
                        <i class="fas fa-download"></i> ркПркХрлНрк╕рккрлЛрк░рлНркЯ
                    </button>
                    <button class="modal-button" onclick="importVanshavali()" style="flex: 1; background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <i class="fas fa-upload"></i> ркЗркорлНрккрлЛрк░рлНркЯ
                    </button>
                </div>
                
                <button class="modal-button" onclick="resetVanshavali()" style="margin-top: 10px; background: linear-gradient(135deg, #ef4444, #dc2626);">
                    <i class="fas fa-redo"></i> ркбрк┐рклрлЙрк▓рлНркЯ рккрк░ рк░рлАрк╕рлЗркЯ
                </button>
            </div>
            
            <!-- Camera Tab -->
            <div id="cameraTab" class="tab-content">
                <h3 style="color: var(--pink); margin-bottom: 15px; text-align: center;">ЁЯУ╖ ркХрлЕркорлЗрк░рк╛</h3>
                
                <button class="modal-button" onclick="toggleCamera()" style="margin-bottom: 15px;">
                    <i class="fas fa-camera"></i> ркХрлЕркорлЗрк░рк╛ ркЪрк╛рк▓рлБ/ркмркВркз
                </button>
                
                <div id="camBox">
                    <video id="videoFeed" autoplay playsinline></video>
                    <button class="modal-button" onclick="runVision()" 
                            style="position:absolute; bottom:10px; left:5%; width:90%; background: linear-gradient(135deg, var(--green), #3b82f6);">
                        <i class="fas fa-eye"></i> рклрлЛркЯрлЛ ркЬрлБркУ ркЕркирлЗ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг ркХрк░рлЛ
                    </button>
                </div>
                
                <div style="margin-top: 20px; color: #94a3b8; font-size: 14px; text-align: center;">
                    <p>ркХрлЕркорлЗрк░рк╛ркирлЛ ркЙрккркпрлЛркЧ ркХрк░рлАркирлЗ:</p>
                    <p>1. рккрк╣рлЗрк▓рк╛ 'ркХрлЕркорлЗрк░рк╛ ркЪрк╛рк▓рлБ' ркХрк░рлЛ</p>
                    <p>2. рккркЫрлА 'рклрлЛркЯрлЛ ркЬрлБркУ' ркмркЯрки ркжркмрк╛рк╡рлЛ</p>
                </div>
            </div>
            
            <div class="close-btn" onclick="toggleModal('settingsModal')">
                <i class="fas fa-times"></i> ркмркВркз ркХрк░рлЛ
            </div>
        </div>
    </div>

    <!-- Vanshavali Data External Script -->
    <script src="vanshavali_data.js"></script>

    <script>
        // рк╡рк┐ркбрк┐ркУ рк╕рлНркЯрлЗркЯрлНрк╕
        const videoStates = {
            'silent': 'silent.mp4',
            'talking': 'talking.mp4', 
            'thinking': 'thinking.mp4',
            'smiling': 'smiling.mp4'
        };
        
        // ркбрк╛ркпрк░рлА ркПркирлНркЯрлНрк░рлАркЭ
        let diaryEntries = [];
        
        // рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛
        let vanshavaliData = null;

        // рк╡рк┐ркбрк┐ркУ ркмркжрк▓рк╡рк╛ркирлБркВ рклркВркХрлНрк╢рки
        function setVideo(state) {
            const video = document.getElementById('mainVideo');
            const status = document.getElementById('status');
            
            if(videoStates[state]) {
                video.src = videoStates[state];
                video.play().catch(e => console.log("рк╡рк┐ркбрк┐ркУ ркЪрк▓рк╛рк╡рк╡рк╛ркорк╛ркВ ркнрлВрк▓:", e));
                
                // рк╕рлНркЯрлЗркЯрк╕ ркЕрккркбрлЗркЯ
                switch(state) {
                    case 'talking':
                        status.textContent = "ЁЯОд Divinity ркмрлЛрк▓рлЗ ркЫрлЗ...";
                        status.style.color = "#34d399";
                        break;
                    case 'thinking':
                        status.textContent = "ЁЯдФ Divinity рк╡рк┐ркЪрк╛рк░рлЗ ркЫрлЗ...";
                        status.style.color = "#3b82f6";
                        break;
                    case 'silent':
                        status.textContent = "ЁЯС╕ Divinity ркдрлИркпрк╛рк░ ркЫрлЗ";
                        status.style.color = "var(--pink)";
                        break;
                    case 'smiling':
                        status.textContent = "ЁЯШК Divinity ркдркорк╛рк░рлБркВ рк╕рлНрк╡рк╛ркЧркд ркХрк░рлЗ ркЫрлЗ";
                        status.style.color = "var(--pink)";
                        break;
                }
            }
        }

        // ркорлЛркбрк▓ ркЯрлЛркЧрк▓
        function toggleModal(id) {
            const modal = document.getElementById(id);
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
                if (id === 'settingsModal') {
                    loadDiaryEntries();
                    loadVanshavaliTree();
                    updateParentSelect();
                }
            }
        }

        // Tab switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // ркХрлЕркорлЗрк░рк╛ ркЯрлЛркЧрк▓
        async function toggleCamera() {
            const box = document.getElementById('camBox');
            const feed = document.getElementById('videoFeed');
            
            if(box.style.display === 'block') {
                if(feed.srcObject) feed.srcObject.getTracks().forEach(track => track.stop());
                box.style.display = 'none';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });
                    feed.srcObject = stream;
                    box.style.display = 'block';
                } catch (error) {
                    alert("ркХрлЕркорлЗрк░рк╛ ркорк╛ркЯрлЗ рккрк░рк╡рк╛ркиркЧрлА ркЖрккрлЛ: " + error.message);
                }
            }
        }

        // Divinity ркмрлЛрк▓рк╡рк╛ркирлБркВ рклркВркХрлНрк╢рки
        function speak(text) {
            window.speechSynthesis.cancel();
            
            const speech = new SpeechSynthesisUtterance();
            speech.text = cleanGujaratiText(text);
            speech.lang = 'gu-IN';
            speech.rate = 1.0;
            speech.pitch = 1.2;
            speech.volume = 1.0;
            
            speech.onstart = function() {
                setVideo('talking');
                document.getElementById('micBtn').classList.add('listening');
            };
            
            speech.onend = speech.onerror = function() {
                setVideo('silent');
                document.getElementById('micBtn').classList.remove('listening');
            };
            
            window.speechSynthesis.speak(speech);
        }

        // ркЧрлБркЬрк░рк╛ркдрлА ркЯрлЗркХрлНрк╕рлНркЯ рк╕рк╛ркл ркХрк░рлЛ
        function cleanGujaratiText(text) {
            return text.replace(/[^\u0A80-\u0AFFa-zA-Z0-9\s.,!?ркХрлНрк░рко]/g, ' ');
        }

        // AI рк╕рк╛ркерлЗ ркХркирлЗркХрлНркЯ ркХрк░рлЛ
        async function fetchAI(prompt, imageBase64 = null) {
            console.log("ЁЯФН AI ркХрлЙрк▓ ркерк╛ркп ркЫрлЗ:", { prompt, model: document.getElementById('activeModel').value });
            
            const model = document.getElementById('activeModel').value;
            const geminiKeys = (localStorage.getItem('div_gemini_keys') || "").split(',').filter(k => k.trim());
            const groqKey = localStorage.getItem('div_groq_key');
            
            setVideo('thinking');
            
            try {
                if (model === "groq") {
                    if (!groqKey) throw new Error("Groq API ркХрлА ркорлВркХрлЛ");
                    
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${groqKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: "llama3-70b-8192",
                            messages: [{
                                role: "user",
                                content: `ркдрлБркВ ркПркХ рк╕рлНркдрлНрк░рлА AI рк╕рк╣рк╛ркпркХ ркЫрлЛ ркЬрлЗркирлБркВ ркирк╛рко Divinity ркЫрлЗ. ркдрлБркВ рк╣ркВркорлЗрк╢рк╛ рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ ркЬ ркмрлЛрк▓рлЗ ркЫрлЗ. ркирлАркЪрлЗркирк╛ рккрлНрк░рк╢рлНркиркирлЛ ркЯрлВркВркХрлЛ, рк╕рк░рк│ ркЕркирлЗ ркорлИркдрлНрк░рлАрккрлВрк░рлНркг ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркЬрк╡рк╛ркм ркЖркк (рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ):\n\n${prompt}`
                            }],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    if (!response.ok) throw new Error(`Groq error: ${response.status}`);
                    const data = await response.json();
                    const responseText = data.choices[0].message.content;
                    console.log("тЬЕ AI рккрлНрк░ркдрк┐ркнрк╛рк╡:", responseText);
                    return responseText;
                    
                } else {
                    if (!geminiKeys.length) throw new Error("Gemini API ркХрлА ркорлВркХрлЛ");
                    
                    const apiKey = geminiKeys[Math.floor(Math.random() * geminiKeys.length)];
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const parts = [{
                        text: `ркдрлБркВ ркПркХ рк╕рлНркдрлНрк░рлА AI рк╕рк╣рк╛ркпркХ ркЫрлЛ ркЬрлЗркирлБркВ ркирк╛рко Divinity ркЫрлЗ. ркдрлБркВ рк╣ркВркорлЗрк╢рк╛ рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ ркЬ ркмрлЛрк▓рлЗ ркЫрлЗ. ркирлАркЪрлЗркирк╛ рккрлНрк░рк╢рлНркиркирлЛ ркЯрлВркВркХрлЛ, рк╕рк░рк│ ркЕркирлЗ ркорлИркдрлНрк░рлАрккрлВрк░рлНркг ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркЬрк╡рк╛ркм ркЖркк (рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ):\n\n${prompt}`
                    }];
                    
                    if (imageBase64) {
                        parts.push({
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: imageBase64
                            }
                        });
                    }
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 500
                            }
                        })
                    });
                    
                    if (!response.ok) throw new Error(`Gemini error: ${response.status}`);
                    const data = await response.json();
                    const responseText = data.candidates[0].content.parts[0].text;
                    console.log("тЬЕ AI рккрлНрк░ркдрк┐ркнрк╛рк╡:", responseText);
                    return responseText;
                }
            } catch (error) {
                console.error("тЭМ AI ркнрлВрк▓:", error.message);
                return `ркорк╛ркл ркХрк░ркЬрлЛ, AI рк╕рк╛ркерлЗ ркЬрлЛркбрк╛ркгркорк╛ркВ рк╕ркорк╕рлНркпрк╛ ркЫрлЗ: ${error.message}`;
            }
        }

        // ркбрк╛ркпрк░рлА ркПркирлНркЯрлНрк░рлА ркЙркорлЗрк░рк╡рлА
        function addDiaryEntry() {
            const entryText = document.getElementById('newDiaryEntry').value.trim();
            if (!entryText) {
                alert("ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркХркВркИркХ рк▓ркЦрлЛ");
                return;
            }
            
            const newEntry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('gu-IN'),
                time: new Date().toLocaleTimeString('gu-IN', { hour: '2-digit', minute: '2-digit' }),
                content: entryText
            };
            
            diaryEntries.unshift(newEntry);
            saveDiaryEntries();
            loadDiaryEntries();
            document.getElementById('newDiaryEntry').value = '';
            
            speak("ркбрк╛ркпрк░рлАркорк╛ркВ ркирлЛркВркз ркЙркорлЗрк░рлА ркЧркИ ркЫрлБркВ");
        }

        // ркбрк╛ркпрк░рлА ркПркирлНркЯрлНрк░рлАркЭ рк▓рлЛркб ркХрк░рк╡рлА
        function loadDiaryEntries() {
            const entriesContainer = document.getElementById('diaryEntries');
            entriesContainer.innerHTML = '';
            
            if (diaryEntries.length === 0) {
                entriesContainer.innerHTML = '<p style="text-align:center; color:#94a3b8;">рк╣ркЬрлА ркХрлЛркИ ркирлЛркВркз ркиркерлА</p>';
                return;
            }
            
            diaryEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'diary-entry';
                entryDiv.innerHTML = `
                    <div class="diary-date">ЁЯУЕ ${entry.date} тП░ ${entry.time}</div>
                    <div class="diary-content">${entry.content}</div>
                    <button onclick="deleteDiaryEntry(${entry.id})" style="margin-top:10px; background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:5px; font-size:12px;">
                        <i class="fas fa-trash"></i> ркжрлВрк░ ркХрк░рлЛ
                    </button>
                `;
                entriesContainer.appendChild(entryDiv);
            });
        }

        // ркбрк╛ркпрк░рлА ркПркирлНркЯрлНрк░рлА ркбрк┐рк▓рлАркЯ ркХрк░рк╡рлА
        function deleteDiaryEntry(id) {
            diaryEntries = diaryEntries.filter(entry => entry.id !== id);
            saveDiaryEntries();
            loadDiaryEntries();
            speak("ркирлЛркВркз ркжрлВрк░ ркХрк░рлА ркЧркИ ркЫрлБркВ");
        }

        // ркбрк╛ркпрк░рлА рк╕рлЗрк╡ ркХрк░рк╡рлА
        function saveDiaryEntries() {
            localStorage.setItem('div_diary_entries', JSON.stringify(diaryEntries));
        }

        // ркбрк╛ркпрк░рлА рк▓рлЛркб ркХрк░рк╡рлА
        function loadSavedDiaryEntries() {
            const saved = localStorage.getItem('div_diary_entries');
            if (saved) diaryEntries = JSON.parse(saved);
        }

        // рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рк╕рлЗрк╡ ркХрк░рк╡рлЛ
        function saveVanshavaliData() {
            localStorage.setItem('div_vanshavali_data', JSON.stringify(vanshavaliData));
        }

        // рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркХрк░рк╡рлЛ
        function loadSavedVanshavaliData() {
            const saved = localStorage.getItem('div_vanshavali_data');
            if (saved) {
                vanshavaliData = JSON.parse(saved);
                console.log("тЬЕ Local storage рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркХрк░рлНркпрлЛ");
            } else {
                // ркЬрлЛ localStorage ркорк╛ркВ рки рк╣рлЛркп ркдрлЛ external file ркорк╛ркВркерлА рк▓рлЛркб ркХрк░рлЛ
                if (typeof window.vanshavaliData !== 'undefined') {
                    vanshavaliData = window.vanshavaliData;
                    console.log("тЬЕ External file рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркХрк░рлНркпрлЛ:", vanshavaliData.name);
                } else {
                    console.error("тЭМ ркмркВркирлЗ ркЬркЧрлНркпрк╛ркП рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА");
                    // ркбрк┐рклрлЙрк▓рлНркЯ ркбрлЗркЯрк╛ ркмркирк╛рк╡рлЛ
                    vanshavaliData = {
                        name: "ркорк╛рк░рлЛ рккрк░рк┐рк╡рк╛рк░",
                        info: "ркорлБркЦрлНркп ркХрлБркЯрлБркВркм",
                        children: []
                    };
                }
            }
        }

        // рк╡ркВрк╢рк╛рк╡рк│рлА ркЯрлНрк░рлА ркбрк┐рк╕рлНрккрлНрк▓рлЗ
        function loadVanshavaliTree() {
            const treeContainer = document.getElementById('familyTreeDisplay');
            treeContainer.innerHTML = '';
            
            if (!vanshavaliData) {
                treeContainer.innerHTML = '<p style="text-align:center; color:#94a3b8;">рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА</p>';
                return;
            }
            
            const treeHtml = generateTreeHTML(vanshavaliData, 0);
            treeContainer.innerHTML = treeHtml;
        }

        // ркЯрлНрк░рлА HTML ркЬркирк░рлЗркЯ
        function generateTreeHTML(node, level) {
            let html = '';
            const indent = level * 20;
            
            if (level > 0) {
                html += `<div class="tree-node" style="margin-left: ${indent}px;">`;
            }
            
            html += `<div class="member-name">${node.name}</div>`;
            if (node.info) {
                html += `<div class="member-info">${node.info}</div>`;
            }
            
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    html += generateTreeHTML(child, level + 1);
                });
            }
            
            if (level > 0) {
                html += '</div>';
            }
            
            return html;
        }

        // рккрлЗрк░ркирлНркЯ рк╕рк┐рк▓рлЗркХрлНркЯ ркЕрккркбрлЗркЯ
        function updateParentSelect() {
            const select = document.getElementById('parentMember');
            select.innerHTML = '<option value="root">ркорлБркЦрлНркп (рк░рлБркЯ)</option>';
            
            if (!vanshavaliData) return;
            
            function addMembers(node, depth = 0) {
                if (node.name !== vanshavaliData.name) {
                    const prefix = 'тФА '.repeat(depth);
                    select.innerHTML += `<option value="${node.name}">${prefix}${node.name}</option>`;
                }
                
                if (node.children) {
                    node.children.forEach(child => {
                        addMembers(child, depth + 1);
                    });
                }
            }
            
            addMembers(vanshavaliData);
        }

        // рк╕ркнрлНркп ркЙркорлЗрк░рлЛ
        function addFamilyMember() {
            const name = document.getElementById('newMemberName').value.trim();
            const info = document.getElementById('newMemberInfo').value.trim();
            const parentName = document.getElementById('parentMember').value;
            
            if (!name) {
                alert("ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк╕ркнрлНркпркирлБркВ ркирк╛рко рк▓ркЦрлЛ");
                return;
            }
            
            const newMember = {
                name: name,
                info: info || "ркирк╡рлЛ рк╕ркнрлНркп",
                children: []
            };
            
            if (parentName === "root") {
                if (!vanshavaliData.children) vanshavaliData.children = [];
                vanshavaliData.children.push(newMember);
            } else {
                function findParent(node, targetName) {
                    if (node.name === targetName) {
                        if (!node.children) node.children = [];
                        node.children.push(newMember);
                        return true;
                    }
                    
                    if (node.children) {
                        for (let child of node.children) {
                            if (findParent(child, targetName)) return true;
                        }
                    }
                    return false;
                }
                
                const found = findParent(vanshavaliData, parentName);
                if (!found) {
                    alert("рккрлЗрк░ркирлНркЯ рк╕ркнрлНркп ркорк│рлНркпрлЛ ркиркерлА");
                    return;
                }
            }
            
            saveVanshavaliData();
            loadVanshavaliTree();
            updateParentSelect();
            
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberInfo').value = '';
            
            speak(`${name} рк╡ркВрк╢рк╛рк╡рк│рлАркорк╛ркВ ркЙркорлЗрк░рлА ркЧркпрк╛ ркЫрлАркП`);
        }

        // рк╡ркВрк╢рк╛рк╡рк│рлА ркПркХрлНрк╕рккрлЛрк░рлНркЯ
        function exportVanshavali() {
            const dataStr = JSON.stringify(vanshavaliData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'vanshavali_export.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            speak("рк╡ркВрк╢рк╛рк╡рк│рлА ркПркХрлНрк╕рккрлЛрк░рлНркЯ ркХрк░рлА ркЧркИ ркЫрлБркВ");
        }

        // рк╡ркВрк╢рк╛рк╡рк│рлА ркЗркорлНрккрлЛрк░рлНркЯ
        function importVanshavali() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        vanshavaliData = importedData;
                        saveVanshavaliData();
                        loadVanshavaliTree();
                        updateParentSelect();
                        
                        const memberCount = countTreeMembers(vanshavaliData);
                        speak(`${memberCount} рк╕ркнрлНркпрлЛ рк╕рк╛ркерлЗркирлА рк╡ркВрк╢рк╛рк╡рк│рлА рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ ркЗркорлНрккрлЛрк░рлНркЯ ркХрк░рлА ркЧркИ ркЫрлБркВ`);
                    } catch (error) {
                        alert("рклрк╛ркИрк▓ рклрлЛрк░рлНркорлЗркЯ ркЦрлЛркЯрлБркВ ркЫрлЗ: " + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // рк╡ркВрк╢рк╛рк╡рк│рлА рк░рлАрк╕рлЗркЯ
        function resetVanshavali() {
            if (confirm("рк╢рлБркВ ркдркорлЗ ркЦрк░рлЗркЦрк░ ркбрк┐рклрлЙрк▓рлНркЯ рк╡ркВрк╢рк╛рк╡рк│рлА рккрк░ рк░рлАрк╕рлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркВркЧрлЛ ркЫрлЛ? ркдркорк╛рк░рлЛ рк╡рк░рлНркдркорк╛рки ркбрлЗркЯрк╛ ркЧрлБркорк╛рк╡рк╢рлЛ.")) {
                // External file ркорк╛ркВркерлА ркбрлЗркЯрк╛ рк▓рлЛркб ркХрк░рлЛ
                if (typeof window.vanshavaliData !== 'undefined') {
                    vanshavaliData = window.vanshavaliData;
                    console.log("тЬЕ External file рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рккрк░ рк░рлАрк╕рлЗркЯ ркХрк░рлНркпрлЛ");
                } else {
                    // ркбрк┐рклрлЙрк▓рлНркЯ ркбрлЗркЯрк╛
                    vanshavaliData = {
                        name: "ркорк╛рк░рлЛ рккрк░рк┐рк╡рк╛рк░",
                        info: "ркорлБркЦрлНркп ркХрлБркЯрлБркВркм",
                        children: []
                    };
                }
                
                saveVanshavaliData();
                loadVanshavaliTree();
                updateParentSelect();
                
                speak("рк╡ркВрк╢рк╛рк╡рк│рлА ркбрк┐рклрлЙрк▓рлНркЯ рккрк░ рк░рлАрк╕рлЗркЯ ркХрк░рлА ркЧркИ ркЫрлБркВ");
            }
        }

        // ркЗркирлНркЯрк░рлЗркХрлНрк╢рки рк╢рк░рлВ ркХрк░рлЛ
        function startInteraction() {
            const micBtn = document.getElementById('micBtn');
            micBtn.classList.add('listening');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                speak("ркорк╛ркл ркХрк░ркЬрлЛ, ркЖ ркмрлНрк░рк╛ркЙркЭрк░ркорк╛ркВ рк╡рлЙркЗрк╕ рк╕рккрлЛрк░рлНркЯ ркиркерлА.");
                micBtn.classList.remove('listening');
                return;
            }
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onresult = async function(event) {
                const speechText = event.results[0][0].transcript;
                console.log("ркдркорлЗ ркХрк╣рлНркпрлБркВ:", speechText);
                
                // ркбрк╛ркпрк░рлА ркХркорк╛ркирлНркб
                if (speechText.includes("ркирлЛркВркз ркХрк░рлЛ") || speechText.includes("ркбрк╛ркпрк░рлАркорк╛ркВ рк▓ркЦрлЛ")) {
                    const note = speechText.replace("ркирлЛркВркз ркХрк░рлЛ", "").replace("ркбрк╛ркпрк░рлАркорк╛ркВ рк▓ркЦрлЛ", "").trim();
                    if (note) {
                        const newEntry = {
                            id: Date.now(),
                            date: new Date().toLocaleDateString('gu-IN'),
                            time: new Date().toLocaleTimeString('gu-IN', { hour: '2-digit', minute: '2-digit' }),
                            content: note
                        };
                        diaryEntries.unshift(newEntry);
                        saveDiaryEntries();
                        speak(`ркбрк╛ркпрк░рлАркорк╛ркВ ркирлЛркВркз ркХрк░рлА ркЧркИ ркЫрлБркВ: ${note}`);
                    } else {
                        speak("ркбрк╛ркпрк░рлАркорк╛ркВ рк╢рлБркВ рк▓ркЦрк╡рлБркВ ркЫрлЗ? ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркХрк╣рлЛ.");
                    }
                    return;
                }
                
                // рк╡ркВрк╢рк╛рк╡рк│рлА ркХркорк╛ркирлНркб
                if (speechText.includes("рк╡ркВрк╢рк╛рк╡рк│рлА") || speechText.includes("рккрк░рк┐рк╡рк╛рк░") || speechText.includes("рк╡ркВрк╢")) {
                    if (vanshavaliData) {
                        const count = countTreeMembers(vanshavaliData);
                        speak(`ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк│рлАркорк╛ркВ ${count} рк╕ркнрлНркпрлЛ ркЫрлЗ. рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВ ркЬркИркирлЗ ркЬрлЛркИ рк╢ркХрлЛ ркЫрлЛ.`);
                    } else {
                        speak("рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ ркорк│рлНркпрлЛ ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВркерлА рк╕ркнрлНркп ркЙркорлЗрк░рлЛ.");
                    }
                    return;
                }
                
                // ркХрлЗрк▓рлНркХрлНркпрлБрк▓рлЗркЯрк░
                if (speechText.includes("ркХрлЗрк▓рлНркХрлНркпрлБрк▓рлЗркЯрк░")) {
                    speak("ркХрлЗрк▓рлНркХрлНркпрлБрк▓рлЗркЯрк░ ркЦрлЛрк▓рлБркВ ркЫрлБркВ.");
                    setTimeout(() => {
                        if (navigator.userAgent.includes('Android')) {
                            window.location.href = "intent://com.android.calculator2/#Intent;scheme=android-app;end";
                        }
                    }, 1000);
                    return;
                }
                
                // ркдрк╛рк░рлБркВ ркирк╛рко рк╢рлБркВ ркЫрлЗ?
                if (speechText.includes("ркдрк╛рк░рлБркВ ркирк╛рко рк╢рлБркВ") || speechText.includes("ркирк╛рко рк╢рлБркВ ркЫрлЗ")) {
                    speak("ркорк╛рк░рлБркВ ркирк╛рко Divinity ркЫрлЗ. рк╣рлБркВ ркдркорк╛рк░рлА AI рк╕рк╣рк╛ркпркХ ркЫрлБркВ.");
                    return;
                }
                
                // ркЬркп рк╕рлАркпрк╛рк░рк╛рко
                if (speechText.includes("ркЬркп рк╕рлАркпрк╛рк░рк╛рко")) {
                    speak("ркЬркп рк╕рлАркпрк╛рк░рк╛рко! ркоркирлЗ ркдркорк╛рк░рлА рк╕рлЗрк╡рк╛ ркХрк░рк╡рк╛ркирлА ркЦрлБрк╢рлА ркЫрлЗ.");
                    return;
                }
                
                // рк╣рлЗрк▓рлЛ / рк╣рк╛ркп
                if (speechText.includes("рк╣рлЗрк▓рлЛ") || speechText.includes("рк╣рк╛ркп") || speechText.includes("ркиркорк╕рлНркдрлЗ")) {
                    speak("рк╣рлЗрк▓рлЛ! рк╣рлБркВ Divinity ркЫрлБркВ. ркдркоркирлЗ ркХрлЗрк╡рлА рк░рлАркдрлЗ ркоркжркж ркХрк░рлА рк╢ркХрлБркВ?");
                    return;
                }
                
                // AI ркирлЗ рккрлНрк░рк╢рлНрки
                setVideo('thinking');
                const response = await fetchAI(speechText);
                speak(response);
            };
            
            recognition.onerror = function(event) {
                console.error("рк░рлЗркХрлЛркЧрлНркирк┐рк╢рки ркнрлВрк▓:", event.error);
                speak("ркдркорк╛рк░рлЛ ркЕрк╡рк╛ркЬ рк╕ркоркЬрк╛ркпрлЛ ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.");
                micBtn.classList.remove('listening');
            };
            
            recognition.onend = function() {
                micBtn.classList.remove('listening');
            };
            
            recognition.start();
        }

        // ркЯрлНрк░рлАркорк╛ркВ рк╕ркнрлНркпрлЛ ркЧркгрлЛ
        function countTreeMembers(node) {
            let count = 1;
            if (node.children) {
                node.children.forEach(child => {
                    count += countTreeMembers(child);
                });
            }
            return count;
        }

        // ркХрлНрк╡рк┐ркХ ркПркХрлНрк╢ркирлНрк╕
        function quickAction(action) {
            switch(action) {
                case 'openSettings':
                    toggleModal('settingsModal');
                    break;
                case 'diary':
                    toggleModal('settingsModal');
                    setTimeout(() => switchTab('diaryTab'), 100);
                    break;
                case 'vanshavali':
                    toggleModal('settingsModal');
                    setTimeout(() => switchTab('vanshavaliTab'), 100);
                    break;
                case 'camera':
                    toggleModal('settingsModal');
                    setTimeout(() => switchTab('cameraTab'), 100);
                    break;
            }
        }

        // рк╡рк┐ркЭрки ркПркирк╛рк▓рк┐рк╕рк┐рк╕
        async function runVision() {
            const video = document.getElementById('videoFeed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];
            toggleModal('settingsModal');
            
            const analysis = await fetchAI("ркЖ рклрлЛркЯрк╛ркорк╛ркВ рк╢рлБркВ ркЫрлЗ? рк╡рк┐ркЧркдрк╡рк╛рк░ рк╡рк░рлНркгрки ркХрк░рлЛ.", imageBase64);
            speak(analysis);
        }

        // ркмркзрлБркВ ркмркВркз ркХрк░рлЛ
        function stopEverything() {
            window.speechSynthesis.cancel();
            setVideo('silent');
            document.getElementById('micBtn').classList.remove('listening');
            
            const feed = document.getElementById('videoFeed');
            if (feed.srcObject) {
                feed.srcObject.getTracks().forEach(track => track.stop());
                document.getElementById('camBox').style.display = 'none';
            }
        }

        // ркХрлЛркирлНрклрк┐ркЧ рк╕рлЗрк╡ ркХрк░рлЛ
        function saveConfig() {
            const model = document.getElementById('activeModel').value;
            const geminiKeys = document.getElementById('geminiKeys').value;
            const groqKey = document.getElementById('groqKey').value;
            
            localStorage.setItem('div_active_model', model);
            localStorage.setItem('div_gemini_keys', geminiKeys);
            localStorage.setItem('div_groq_key', groqKey);
            
            speak("рк╕рлЗркЯрк┐ркВркЧрлНрк╕ рк╕ркВркЧрлНрк░рк╣рк┐ркд ркХрк░рлА ркЧркИ ркЫрлБркВ");
            toggleModal('settingsModal');
        }

        // рккрлЗркЬ рк▓рлЛркб ркерк╛ркп ркдрлНркпрк╛рк░рлЗ
        window.onload = function() {
            // Load saved data
            loadSavedDiaryEntries();
            loadSavedVanshavaliData();
            
            // Load settings
            document.getElementById('geminiKeys').value = localStorage.getItem('div_gemini_keys') || "";
            document.getElementById('groqKey').value = localStorage.getItem('div_groq_key') || "";
            document.getElementById('activeModel').value = localStorage.getItem('div_active_model') || "groq";
            
            // Show welcome
            setTimeout(() => {
                document.getElementById('welcomeOverlay').style.display = 'none';
                setVideo('smiling');
                
                setTimeout(() => {
                    speak("рк╣рлБркВ Divinity ркЫрлБркВ, ркдркорк╛рк░рлА AI рк╕рк╣рк╛ркпркХ. ркорк╛рк░рлА рк╕рк╛ркерлЗ ркмрлЛрк▓рлАркирлЗ рк╡рк╛ркд ркХрк░рлЛ. ркоркирлЗ ркбрк╛ркпрк░рлАркорк╛ркВ ркирлЛркВркз ркХрк░рк╡рлА рк╣рлЛркп ркдрлЛ 'ркирлЛркВркз ркХрк░рлЛ' ркХрк╣рлЛ.");
                    setVideo('silent');
                }, 1000);
            }, 2000);
        };

        // рккрлЗркЬ ркЕркирк▓рлЛркб ркерк╛ркп ркдрлНркпрк╛рк░рлЗ
        window.onbeforeunload = function() {
            stopEverything();
        };
        
        // Touch event for better mobile
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Console helper for testing
        console.log("ЁЯФз Divinity AI Loaded!");
        console.log("ркЯрлЗрк╕рлНркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ:");
        console.log("1. localStorage.setItem('div_gemini_keys', 'AIzaSy...')");
        console.log("2. speak('рк╣рлЗрк▓рлЛ ркЯрлЗрк╕рлНркЯ')");
        console.log("3. рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛:", vanshavaliData);
    </script>
</body>
</html>
