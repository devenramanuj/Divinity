<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divinity AI - Universal Oracle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --accent: #f43f5e; --glass: rgba(0, 0, 0, 0.7); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Poppins', sans-serif; background: black; color: white; }
        #video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .controls-overlay { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 20px; z-index: 10; }
        .btn-mic { width: 75px; height: 75px; background: white; color: black; border: none; border-radius: 50%; font-size: 30px; cursor: pointer; box-shadow: 0 0 30px rgba(255,255,255,0.2); transition: 0.3s; }
        .btn-mic.listening { background: var(--accent); color: white; animation: pulse 1.5s infinite; }
        .btn-stop { width: 55px; height: 55px; background: #ef4444; color: white; border: none; border-radius: 50%; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .settings-btn { position: fixed; top: 20px; right: 20px; z-index: 10; font-size: 26px; color: rgba(255,255,255,0.6); cursor: pointer; padding: 10px; }
        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .settings-content { background: #1e293b; padding: 30px; border-radius: 28px; width: 85%; max-width: 380px; max-height: 85vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
        .setting-section { margin-bottom: 25px; text-align: left; }
        h3 { font-size: 13px; color: #818cf8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        input, select { width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; color: #34d399; border-radius: 12px; margin-bottom: 12px; box-sizing: border-box; outline: none; }
        #cameraPreview { width: 100%; height: 180px; background: black; border-radius: 15px; margin-top: 10px; display: none; object-fit: cover; }
        #reportModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 80%; background: #111827; color: white; border-radius: 24px; z-index: 200; padding: 25px; overflow-y: auto; border: 1px solid #4f46e5; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <video autoplay loop muted playsinline id="video-background">
        <source src="smiling.mp4" type="video/mp4">
    </video>

    <i class="fas fa-cog settings-btn" onclick="toggleSettings()"></i>

    <div class="controls-overlay">
        <button class="btn-stop" onclick="stopAll()"><i class="fas fa-stop"></i></button>
        <button id="micBtn" class="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
    </div>

    <div id="settingsModal">
        <div class="settings-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; font-size:22px; color:white;">Divinity Settings</h2>
                <i class="fas fa-times" onclick="toggleSettings()" style="cursor:pointer; font-size:22px; color:#94a3b8;"></i>
            </div>

            <div class="setting-section">
                <h3>API Keys & Model</h3>
                <select id="modelSelect">
                    <option value="gemini">Gemini 2.5 Flash</option>
                    <option value="groq">Groq Llama 3 70B</option>
                </select>
                <input type="password" id="geminiKey" placeholder="Gemini API Key">
                <input type="password" id="groqKey" placeholder="Groq API Key">
                <button onclick="saveAllSettings()" style="width:100%; padding:14px; background: linear-gradient(45deg, #4f46e5, #6366f1); border:none; border-radius:12px; color:white; font-weight:bold; cursor:pointer;">Save Keys</button>
            </div>

            <div class="setting-section">
                <h3>Knowledge Base (RAG)</h3>
                <input type="file" id="ragFileUpload" accept=".txt" onchange="handleRAGUpload(event)">
                <p id="fileStatus" style="font-size:10px; color:#94a3b8;"></p>
            </div>

            <div class="setting-section">
                <h3>Smart Lens (Camera)</h3>
                <button onclick="toggleCamera()" style="width:100%; padding:12px; background:#334155; border:none; color:white; border-radius:12px; cursor:pointer; margin-bottom:10px;"><i class="fas fa-camera"></i> Camera On/Off</button>
                <video id="cameraPreview" autoplay playsinline></video>
                <button id="analyzeBtn" onclick="analyzeVision()" style="width:100%; padding:12px; background:#818cf8; border:none; color:white; border-radius:12px; cursor:pointer; margin-top:10px; display:none;"><i class="fas fa-search"></i> Analyze Everything</button>
            </div>
        </div>
    </div>

    <div id="reportModal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:18px; color:#818cf8;">Analysis Report</h2>
            <div style="display:flex; gap:10px;">
                <button onclick="downloadReport()" style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;"><i class="fas fa-download"></i> Save</button>
                <button onclick="closeReport()" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div id="reportContent" style="line-height:1.6; font-size:15px; color:#e5e7eb; white-space:pre-wrap; margin-top:20px;">લિપી અથવા વસ્તુનું વિશ્લેષણ થઈ રહ્યું છે...</div>
    </div>

    <script>
        const videoBg = document.getElementById('video-background');
        let ragData = localStorage.getItem('rag_data') || "";

        function playVideo(state) {
            videoBg.src = state + '.mp4';
            videoBg.load();
            videoBg.play().catch(e => {});
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function handleRAGUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    ragData = e.target.result;
                    localStorage.setItem('rag_data', ragData);
                    document.getElementById('fileStatus').innerText = "Knowledge Saved: " + file.name;
                };
                reader.readAsText(file);
            }
        }

        function saveAllSettings() {
            localStorage.setItem('gemini_key', document.getElementById('geminiKey').value);
            localStorage.setItem('groq_key', document.getElementById('groqKey').value);
            localStorage.setItem('selected_model', document.getElementById('modelSelect').value);
            alert("બધા સેટિંગ્સ કાયમી ધોરણે સેવ થયા!");
            toggleSettings();
        }

        async function toggleCamera() {
            const video = document.getElementById('cameraPreview');
            const btn = document.getElementById('analyzeBtn');
            if (video.style.display === 'block') {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.style.display = 'none';
                btn.style.display = 'none';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;
                    video.style.display = 'block';
                    btn.style.display = 'block';
                } catch(e) { alert("Camera Error"); }
            }
        }

        async function analyzeVision() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64Img = canvas.toDataURL('image/jpeg').split(',')[1];

            document.getElementById('reportModal').style.display = 'block';
            document.getElementById('reportContent').innerText = "Divinity વિશ્લેષણ કરી રહી છે...";
            playVideo('thinking');

            const key = localStorage.getItem('gemini_key');
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;

            const prompt = "તમે Divinity છો, દેવેન્દ્રભાઈ દ્વારા નિર્મિત. તમારી સામે જે છે તેનું વિગતવાર ગુજરાતી એનાલિસિસ કરો (લિપિ, ગણિત કે વસ્તુ). જવાબમાં *, \", 0 જેવા ચિન્હો ન વાપરવા.";

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt + "\nKnowledge: " + ragData }, { inline_data: { mime_type: "image/jpeg", data: base64Img } }] }]
                    })
                });
                const data = await res.json();
                document.getElementById('reportContent').innerText = data.candidates[0].content.parts[0].text;
                playVideo('smiling');
            } catch (e) { document.getElementById('reportContent').innerText = "Error: " + e.message; }
        }

        function stopAll() { playVideo('smiling'); document.getElementById('micBtn').classList.remove('listening'); }

        function toggleMic() {
            const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.lang = 'gu-IN';
            rec.onstart = () => { playVideo('talking'); document.getElementById('micBtn').classList.add('listening'); };
            rec.onend = () => { document.getElementById('micBtn').classList.remove('listening'); playVideo('smiling'); };
            rec.onresult = (e) => { console.log(e.results[0][0].transcript); };
            rec.start();
        }

        function downloadReport() {
            const blob = new Blob([document.getElementById('reportContent').innerText], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Divinity_Report.txt'; a.click();
        }

        function closeReport() { document.getElementById('reportModal').style.display = 'none'; }

        window.onload = () => {
            document.getElementById('geminiKey').value = localStorage.getItem('gemini_key') || "";
            document.getElementById('groqKey').value = localStorage.getItem('groq_key') || "";
            document.getElementById('modelSelect').value = localStorage.getItem('selected_model') || "gemini";
            if(ragData) document.getElementById('fileStatus').innerText = "Knowledge base ready";
        };
    </script>
</body>
</html>
