<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Devinity</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f4f6fb;
}
header{
  background:#2c3e90;
  color:#fff;
  padding:12px;
  text-align:center;
  font-size:18px;
}
.topbar{
  display:flex;
  justify-content:space-between;
  padding:8px;
  background:#e9ecff;
}
.icon{
  font-size:22px;
  background:none;
  border:none;
}
#avatarWrap{
  width:260px;
  margin:16px auto;
}
#avatarVideo{
  width:100%;
  border-radius:16px;
  background:#000;
}
#chatBox{
  height:28vh;
  overflow-y:auto;
  background:#fff;
  margin:12px;
  padding:12px;
  border-radius:12px;
}
.msg{margin-bottom:8px}
.user{text-align:right;color:#2c3e90}
.bot{text-align:left}
.controls{
  display:flex;
  gap:10px;
  padding:12px;
}
.btn{
  flex:1;
  padding:12px;
  border:none;
  border-radius:10px;
  font-size:15px;
  color:#fff;
}
.green{background:#1e8449}
.red{background:#c0392b}
#settings{
  display:none;
  padding:14px;
}
.section{
  background:#fff;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
}
input,select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<header>Devinity</header>

<div class="topbar">
  <button class="icon" onclick="showChat()">ğŸ’¬</button>
  <button class="icon" onclick="showSettings()">âš™ï¸</button>
</div>

<div id="avatarWrap">
  <video id="avatarVideo"
         autoplay
         playsinline
         muted></video>
</div>

<div id="chat">
  <div id="chatBox"></div>
  <div class="controls">
    <button class="btn green" onclick="startListening()">ğŸ¤ àª¬à«‹àª²à«‹</button>
    <button class="btn red" onclick="stopListening()">â¹ï¸</button>
  </div>
</div>

<div id="settings">
  <div class="section">
    <h4>AI Settings</h4>
    <input id="apiKey" placeholder="Gemini / Groq API Key">
    <select id="model">
      <option value="gemini">Gemini 2.5 Flash</option>
      <option value="groq">Groq 70B</option>
    </select>
  </div>

  <div class="section">
    <h4>DeepSeek Avatar</h4>
    <input id="deepseekKey" placeholder="DeepSeek API Key">
  </div>

  <div class="section">
    <h4>Contacts</h4>
    <input id="cName" placeholder="Name">
    <input id="cNum" placeholder="Number">
    <button class="btn green" onclick="saveContact()">Save</button>
  </div>
</div>

<script>
/* ---------- UI ---------- */
const chatBox = document.getElementById("chatBox");
const chat = document.getElementById("chat");
const settings = document.getElementById("settings");
const avatarVideo = document.getElementById("avatarVideo");

function showChat(){settings.style.display="none";chat.style.display="block";}
function showSettings(){chat.style.display="none";settings.style.display="block";}

function msg(t,c){
  const d=document.createElement("div");
  d.className="msg "+c;
  d.innerText=t;
  chatBox.appendChild(d);
  chatBox.scrollTop=chatBox.scrollHeight;
}

/* ---------- Storage ---------- */
let db;
const open=indexedDB.open("DevinityDB",1);
open.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("contacts",{keyPath:"name"});
  db.createObjectStore("diary",{keyPath:"time"});
};
open.onsuccess=e=>db=e.target.result;

/* ---------- Voice ---------- */
let recog;
if("webkitSpeechRecognition"in window){
  recog=new webkitSpeechRecognition();
  recog.lang="gu-IN";
  recog.onresult=e=>{
    const text=e.results[0][0].transcript;
    msg(text,"user");
    handleCommand(text);
  }
}

function startListening(){recog && recog.start();}
function stopListening(){recog && recog.stop();}

/* ---------- Command Router ---------- */
function handleCommand(text){
  if(text.includes("àª¨à«‹àª‚àª§")){
    saveDiary(text.replace("àª¨à«‹àª‚àª§","").trim());
    return;
  }
  if(text.includes("call")){
    makeCall(text);
    return;
  }
  askAI(text);
}

/* ---------- AI ---------- */
async function askAI(text){
  const key=apiKey.value.trim();
  if(!key){msg("API key àª¸à«‡àªŸ àª•àª°à«‹","bot");return;}

  let reply="";

  if(model.value==="gemini"){
    const r=await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`,
      {method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        contents:[{parts:[{text:
          "You are Devinity, female Gujarati assistant. Gujarati only. No symbols. "+text
        }]}]
      })}
    );
    const j=await r.json();
    reply=j.candidates?.[0]?.content?.parts?.[0]?.text;
  }

  msg(reply,"bot");
  speak(reply);
  playDeepSeek(reply);
}

/* ---------- Speech ---------- */
function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.lang="gu-IN";
  speechSynthesis.speak(u);
}

/* ---------- DeepSeek Avatar ---------- */
async function playDeepSeek(text){
  const key=deepseekKey.value.trim();
  if(!key)return;

  const r=await fetch("https://api.deepseek.com/avatar",{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+key,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      text,
      language:"gu",
      gender:"female"
    })
  });
  const j=await r.json();
  avatarVideo.src=j.video_url;
}

/* ---------- Diary ---------- */
function saveDiary(t){
  const tx=db.transaction("diary","readwrite");
  tx.objectStore("diary").put({time:new Date().toISOString(),text:t});
  msg("àª¨à«‹àª‚àª§ àª¸àª¾àªšàªµà«€ àª²à«€àª§à«€ àª›à«‡","bot");
}

/* ---------- Contacts ---------- */
function saveContact(){
  const tx=db.transaction("contacts","readwrite");
  tx.objectStore("contacts").put({
    name:cName.value.trim(),
    number:cNum.value.trim()
  });
  alert("Contact saved");
}

function makeCall(text){
  const name=text.split("call")[1]?.trim();
  const tx=db.transaction("contacts","readonly");
  const req=tx.objectStore("contacts").get(name);
  req.onsuccess=e=>{
    if(e.target.result){
      const a=document.createElement("a");
      a.href="tel:"+e.target.result.number;
      a.click();
    }else msg("àª¸àª‚àªªàª°à«àª• àª®àª³à«àª¯à«‹ àª¨àª¥à«€","bot");
  }
}
</script>
</body>
</html>
