<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Divinity AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; }
        
        /* Background Video */
        #mainVideo { position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; opacity: 0.7; }
        
        /* UI Overlay */
        .ui-layer { position: absolute; bottom: 60px; left: 0; right: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .ui-layer > * { pointer-events: auto; }
        
        /* Controls (Side by Side) */
        .controls { display: flex; flex-direction: row; gap: 60px; align-items: center; }
        
        .btn { border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.9); }
        .btn i { pointer-events: none; }
        
        .mic { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); font-size: 35px; border: 3px solid #fff; }
        .mic.listening { animation: pulse-mic 1.5s infinite; border-color: #ffd700; }
        
        .stop { width: 60px; height: 60px; border-radius: 50%; background: #ff4757; font-size: 24px; }

        /* Settings Modal Button (Floating) */
        .settings-float { position: fixed; top: 20px; right: 20px; z-index: 100; font-size: 24px; cursor: pointer; background: rgba(255,255,255,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.3); transition: 0.3s; }
        .settings-float:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }

        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); opacity: 0; transition: opacity 0.3s; }
        .modal.active { display: flex; opacity: 1; }
        
        .card { background: #1a1a1a; width: 90%; max-width: 450px; padding: 25px; border-radius: 25px; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
        
        h3 { margin-top: 0; color: #ff9a9e; text-align: center; margin-bottom: 20px; }
        .label { font-size: 13px; color: #aaa; margin-top: 10px; margin-bottom: 5px; display: block; }
        
        select, input, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #2f3542; border: 1px solid #444; color: #fff; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: #ff9a9e; }
        input[type="password"] { letter-spacing: 2px; }

        /* Settings Tools Grid */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .tool-btn { background: #2f3542; padding: 15px; border-radius: 12px; border: none; color: #fff; cursor: pointer; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: 0.2s; }
        .tool-btn i { font-size: 20px; }
        .tool-btn:hover { background: #404040; }
        .tool-btn.cam { color: #2ed573; }
        .tool-btn.book { color: #9c88ff; }
        .tool-btn.note { color: #ffa502; }

        .action-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 15px; transition: 0.2s; }
        .save-btn { background: linear-gradient(45deg, #ff9a9e, #fad0c4); color: #1a1a1a; }
        .close-btn { background: #ff4757; color: #fff; margin-top: 20px; }

        /* Camera, Contacts, Notes Styling */
        #cameraVideo { width: 100%; max-height: 50vh; object-fit: cover; border-radius: 15px; background: #000; display: none; }
        #cameraVideo.active { display: block; }
        .capture-controls { display: none; justify-content: center; gap: 20px; margin-top: 15px; }
        .capture-controls.active { display: flex; }
        .shutter { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #fff; background: transparent; cursor: pointer; }
        
        .list-item { background: #2f3542; padding: 12px; margin-bottom: 8px; border-radius: 10px; font-size: 14px; border-left: 3px solid #ff9a9e; }
        .contact-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .mini-btn-group { display: flex; gap: 8px; justify-content: flex-end; margin-top: 5px; }
        .mini-btn { width: 30px; height: 30px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-size: 12px; }
        .btn-del { background: #ff4757; }
        .btn-wa { background: #25d366; }
        .btn-call { background: #2ed573; }

        /* Status (Minimal) */
        .status-dot { width: 10px; height: 10px; background: #777; border-radius: 50%; display: inline-block; margin-right: 8px; position: absolute; top: 20px; left: 20px; }
        .status-listening { background: #ffd700; box-shadow: 0 0 10px #ffd700; animation: blink 1s infinite; }
        .status-processing { background: #ff9a9e; animation: blink 0.5s infinite; }
        .status-speaking { background: #2ed573; }

        @keyframes blink { 50% { opacity: 0.5; } }

        /* Toast */
        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.9); padding: 10px 20px; border-radius: 20px; z-index: 300; border: 1px solid #444; display: none; font-size: 14px; max-width: 80%; text-align: center; }
    </style>
</head>
<body>

    <video id="mainVideo" autoplay loop muted playsinline><source src="silent.mp4" type="video/mp4"></video>
    
    <!-- Minimal Status Dot (Top Left) -->
    <div class="status-dot" id="statusDot"></div>
    <i class="fas fa-cog settings-float" onclick="toggleSettings()"></i>
    <div id="toast"></div>

    <div class="ui-layer">
        <!-- Mic and Stop Side by Side -->
        <div class="controls">
            <button class="btn mic" id="micBtn" onclick="startVoice()"><i class="fas fa-microphone"></i></button>
            <button class="btn stop" onclick="stopAll()"><i class="fas fa-stop"></i></button>
        </div>
    </div>

    <!-- SETTINGS & TOOLS MODAL -->
    <div id="settingsModal" class="modal">
        <div class="card">
            <h3>âš™ï¸ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h3>
            
            <!-- Provider Selection -->
            <label class="label">ğŸ¤– AI Provider</label>
            <select id="pSel" onchange="updateModels()">
                <option value="gemini">Google Gemini (àª«à«‹àªŸà«‹/àªµàª¿àªàª¨)</option>
                <option value="groq">Groq (àªŸà«‡àª•à«àª¸à«àªŸ àªšà«‡àªŸ)</option>
            </select>

            <!-- Model Selection -->
            <label class="label">ğŸ“Š Model</label>
            <select id="mSel">
                <!-- Options loaded by JS -->
            </select>

            <!-- Keys Section -->
            <div style="border-top: 1px solid #444; margin: 15px 0;"></div>
            
            <label class="label">ğŸ”‘ Gemini Key (àªœàª°à«‚àª°à«€)</label>
            <input type="password" id="geminiKeyInput" placeholder="Gemini API Key">
            
            <label class="label">ğŸ”‘ Groq Key (Optional)</label>
            <input type="password" id="groqKeyInput" placeholder="Groq API Key">

            <div style="margin: 20px 0; border-top: 1px solid #333; padding-top: 10px;">
                <div style="text-align: center; font-size: 12px; color: #777; margin-bottom: 10px;">TOOLS</div>
                <div class="tools-grid">
                    <button class="tool-btn cam" onclick="openCamera()"><i class="fas fa-camera"></i> àª•à«…àª®à«‡àª°àª¾</button>
                    <button class="tool-btn book" onclick="openContacts()"><i class="fas fa-address-book"></i> àª«à«‹àª¨àª¬à«àª•</button>
                    <button class="tool-btn note" onclick="openNotes()"><i class="fas fa-book"></i> àª¨à«‹àª‚àª§ àª¡àª¾àª¯àª°à«€</button>
                    <button class="tool-btn" onclick="saveSettings()"><i class="fas fa-save"></i> Save Keys</button>
                </div>
            </div>

            <button class="action-btn close-btn" onclick="toggleSettings()">àª¬àª‚àª§ àª•àª°à«‹</button>
        </div>
    </div>

    <!-- CAMERA MODAL -->
    <div id="cameraModal" class="modal">
        <div class="card" style="width: 95%; padding: 15px;">
            <h3>ğŸ“· àª¶àª¿àª²àª¾àª²à«‡àª– àª¸à«àª•à«‡àª¨</h3>
            <video id="cameraVideo" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <div id="camPlaceholder" style="padding: 30px; text-align: center; color: #777;">Start Camera</div>
            <div class="capture-controls" id="camControls">
                <button class="btn" onclick="closeCamera()" style="background:#ff4757; width:40px; height:40px;"><i class="fas fa-times"></i></button>
                <button class="shutter" onclick="captureAndAnalyze()"></button>
            </div>
            <button class="action-btn" id="startCamBtn" onclick="initCamera()" style="background:#2ed573;">Start Camera</button>
        </div>
    </div>

    <!-- PHONEBOOK MODAL -->
    <div id="contactsModal" class="modal">
        <div class="card">
            <h3>ğŸ“’ àª«à«‹àª¨àª¬à«àª•</h3>
            <div style="background: #2f3542; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
                <input type="text" id="cName" placeholder="Name (àª¨àª¾àª®)">
                <input type="tel" id="cNum" placeholder="Number (àª¨àª‚àª¬àª°)" onkeypress="return isNumber(event)">
                <button class="action-btn save-btn" onclick="addContact()" style="background:#9c88ff; font-size: 13px;">Add Contact</button>
            </div>
            <div id="contactsList" style="max-height: 40vh; overflow-y: auto;"></div>
            <button class="action-btn close-btn" onclick="toggleContacts()">Close</button>
        </div>
    </div>

    <!-- NOTES MODAL -->
    <div id="notesModal" class="modal">
        <div class="card">
            <h3>ğŸ“’ àª¨à«‹àª‚àª§ àª¡àª¾àª¯àª°à«€</h3>
            <div id="notesList" style="max-height: 40vh; overflow-y: auto;"></div>
            <textarea id="manualNote" rows="2" placeholder="New Note..." style="margin-top:10px;"></textarea>
            <button class="action-btn save-btn" onclick="addManualNote()">Add Note</button>
            <button class="action-btn close-btn" onclick="toggleNotes()">Close</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸŒ CONFIG & MODELS
        // ==========================================
        let currentProvider = localStorage.getItem('p') || 'gemini';
        let currentModel = localStorage.getItem('m') || 'gemini-1.5-flash-latest';
        let mediaStream = null;
        let facingMode = 'environment';
        let notes = JSON.parse(localStorage.getItem('myNotes') || '[]');
        let contacts = JSON.parse(localStorage.getItem('phoneBook') || '[]');
        let memories = JSON.parse(localStorage.getItem('userMemories') || '[]'); // NEW: Long Term Memory
        let myIdentity = "àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª® Divinity àª›à«‡ àª…àª¨à«‡ àª¤àª®àª¨à«‡ Devendrabhai àª àª¬àª¨àª¾àªµà«àª¯à«‹ àª›à«‡. àª¤àª®à«‡ àªàª• àª¦àª¯àª¾àª³à« AI àª›à«‹.";

        const MODEL_OPTS = {
            gemini: [
                { id: "gemini-2.0-flash-exp", name: "Gemini 2.5 Flash (Exp)" },
                { id: "gemini-1.5-flash-latest", name: "Gemini 1.5 Flash (Latest)" },
                { id: "gemini-1.5-pro", name: "Gemini 1.5 Pro" }
            ],
            groq: [
                { id: "llama-3.1-8b-instant", name: "Groq Llama 3.1 8B" },
                { id: "llama-3.3-70b-versatile", name: "Groq Llama 70B" }
            ]
        };

        // ==========================================
        // ğŸ”‘ API KEYS
        // ==========================================
        function getKey() {
            if(currentProvider === 'gemini') return localStorage.getItem('gemini_key');
            return localStorage.getItem('groq_key');
        }

        // ==========================================
        // ğŸ—£ï¸ SPEECH CLEANUP (FIXED ISSUE 1)
        // ==========================================
        function cleanTextForSpeech(text) {
            if(!text) return "";
            // Remove content inside brackets (like punctuation descriptions)
            let clean = text.replace(/\([^)]*\)|\[[^\]]*\]/g, '');
            // Remove special characters that cause TTS to read symbols
            clean = clean.replace(/[.*#-:;,`'"_]/g, '');
            // Remove extra spaces
            return clean.replace(/\s+/g, ' ').trim();
        }

        // ==========================================
        // ğŸ§  MEMORY MANAGEMENT (FIXED ISSUE 2)
        // ==========================================
        function addMemory(fact) {
            memories.push(fact);
            // Keep only last 5 memories to save context space
            if(memories.length > 5) memories.shift();
            localStorage.setItem('userMemories', JSON.stringify(memories));
        }

        function getMemoriesContext() {
            if(memories.length === 0) return "";
            return "\n\nUser's Important Details (Remember these):\n" + memories.map(m => "- " + m).join("\n");
        }

        // ==========================================
        // ğŸ® UI HELPERS
        // ==========================================
        const v = document.getElementById('mainVideo');
        const dotEl = document.getElementById('statusDot');
        const micBtn = document.getElementById('micBtn');

        function setVideo(state) {
            const src = state + ".mp4";
            if(v.src !== src) { v.src = src; v.play().catch(e => {}); }
        }

        function updateStatus(text, type = 'idle') {
            dotEl.className = 'status-dot';
            if(type === 'listening') { dotEl.classList.add('status-listening'); setVideo('thinking'); }
            else if (type === 'processing') { dotEl.classList.add('status-processing'); setVideo('thinking'); }
            else if (type === 'speaking') { dotEl.classList.add('status-speaking'); setVideo('talking'); }
            else setVideo('silent');
        }

        function showToast(text) {
            const t = document.getElementById('toast');
            t.textContent = text;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // ==========================================
        // âš™ï¸ SETTINGS
        // ==========================================
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            m.classList.toggle('active');
            if(m.classList.contains('active')) {
                document.getElementById('pSel').value = currentProvider;
                updateModels(); 
                document.getElementById('geminiKeyInput').value = localStorage.getItem('gemini_key') || '';
                document.getElementById('groqKeyInput').value = localStorage.getItem('groq_key') || '';
            }
        }

        function updateModels() {
            const p = document.getElementById('pSel').value;
            currentProvider = p;
            const mSel = document.getElementById('mSel');
            mSel.innerHTML = '';
            
            MODEL_OPTS[p].forEach(mod => {
                const opt = document.createElement('option');
                opt.value = mod.id;
                opt.text = mod.name;
                mSel.appendChild(opt);
            });
            
            mSel.value = currentModel; 
            if(mSel.selectedIndex === -1) mSel.value = MODEL_OPTS[p][0].id;
        }

        function saveSettings() {
            const gKey = document.getElementById('geminiKeyInput').value.trim();
            const grKey = document.getElementById('groqKeyInput').value.trim();
            
            if(gKey) localStorage.setItem('gemini_key', gKey);
            if(grKey) localStorage.setItem('groq_key', grKey);
            
            currentModel = document.getElementById('mSel').value;
            currentProvider = document.getElementById('pSel').value;
            
            localStorage.setItem('m', currentModel);
            localStorage.setItem('p', currentProvider);
            
            showToast("Saved!");
        }

        // ==========================================
        // ğŸ“’ PHONEBOOK LOGIC
        // ==========================================
        function openContacts() { toggleSettings(); renderContacts(); document.getElementById('contactsModal').classList.add('active'); }
        function toggleContacts() { document.getElementById('contactsModal').classList.remove('active'); }
        function isNumber(evt) { evt = (evt) ? evt : window.event; var charCode = (evt.which) ? evt.which : evt.keyCode; if (charCode > 31 && (charCode < 48 || charCode > 57)) return false; return true; }
        
        function addContact() {
            const name = document.getElementById('cName').value.trim();
            const num = document.getElementById('cNum').value.trim();
            if(!name || !num) return showToast("Name & Number thalo");
            contacts.push({ name, number: num });
            localStorage.setItem('phoneBook', JSON.stringify(contacts));
            document.getElementById('cName').value = '';
            document.getElementById('cNum').value = '';
            renderContacts();
            showToast("Contact Saved");
        }
        function deleteContact(index) { contacts.splice(index, 1); localStorage.setItem('phoneBook', JSON.stringify(contacts)); renderContacts(); }
        
        function findContact(query) {
            const q = query.toLowerCase().trim();
            let match = contacts.find(c => c.name.toLowerCase() === q);
            if(match) return match;
            match = contacts.find(c => c.name.toLowerCase().includes(q) || q.includes(c.name.toLowerCase()));
            return match;
        }
        
        function renderContacts() {
            const list = document.getElementById('contactsList');
            list.innerHTML = '';
            if(contacts.length === 0) list.innerHTML = '<div style="text-align:center; color:#777;">No Contacts</div>';
            else contacts.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="contact-header"><strong>${c.name}</strong> <span style="color:#aaa">${c.number}</span></div>
                    <div class="mini-btn-group">
                        <button class="mini-btn btn-wa" onclick="openWa('${c.number}')"><i class="fab fa-whatsapp"></i></button>
                        <button class="mini-btn btn-call" onclick="openCall('${c.number}')"><i class="fas fa-phone"></i></button>
                        <button class="mini-btn btn-del" onclick="deleteContact(${i})"><i class="fas fa-trash"></i></button>
                    </div>`;
                list.appendChild(div);
            });
        }

        // ==========================================
        // ğŸ“· CAMERA
        // ==========================================
        function openCamera() { toggleSettings(); document.getElementById('cameraModal').classList.add('active'); }
        function closeCamera() { stopCamera(); document.getElementById('cameraModal').classList.remove('active'); }
        async function initCamera() {
            try {
                if(mediaStream) stopCamera();
                const video = document.getElementById('cameraVideo');
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode }, audio: false });
                video.srcObject = mediaStream;
                video.classList.add('active');
                document.getElementById('camPlaceholder').style.display = 'none';
                document.getElementById('camControls').classList.add('active');
                document.getElementById('startCamBtn').style.display = 'none';
            } catch(e) { alert("Camera Error"); }
        }
        function stopCamera() {
            if(mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
            const vid = document.getElementById('cameraVideo');
            vid.srcObject = null;
            vid.classList.remove('active');
        }
        async function captureAndAnalyze() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Image = canvas.toDataURL('image/jpeg').split(',')[1];
            closeCamera();
            updateStatus("Analyzing...", "processing");
            const key = getKey();
            if(!key) { speak("API Key set karo"); return; }
            if(currentProvider !== 'gemini') { speak("Camera mate Gemini select karo"); return; }
            const prompt = "A chabi ma shu che? Jo prachin lipi hoy to vachjo ane Gujarati ma anuvad karo.";
            const response = await callGeminiVision(prompt, base64Image, key);
            speak(response);
        }

        // ==========================================
        // ğŸ§  AI LOGIC (WITH MEMORY)
        // ==========================================
        async function callAI(text, imageBase64 = null) {
            const key = getKey();
            if(!key) { speak("API Key set karo"); return; }
            try {
                if(currentProvider === 'gemini') {
                    return await (imageBase64 ? callGeminiVision(text, imageBase64, key) : callGeminiText(text, key));
                } else {
                    return await callGroq(text, key);
                }
            } catch(e) { console.error(e); speak("Error thayu"); }
        }

        async function callGroq(text, key) {
            const memoryContext = getMemoriesContext();
            const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: currentModel,
                    messages: [
                        { role: "system", content: `System Instruction: ${myIdentity}. Answer in Gujarati.${memoryContext}` },
                        { role: "user", content: text }
                    ],
                    max_tokens: 500
                })
            });
            const data = await res.json();
            return data.choices?.[0]?.message?.content || "Response nathi malyo";
        }

        async function callGeminiText(text, key) {
            const memoryContext = getMemoriesContext();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${key}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `System Instruction: ${myIdentity}${memoryContext}\n\nUser Question: ${text}` }] }]
                })
            });
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Response nathi malyo";
        }

        async function callGeminiVision(text, imageBase64, key) {
            const memoryContext = getMemoriesContext();
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${key}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ 
                        parts: [
                            { text: `System Instruction: ${myIdentity}${memoryContext}\n\nTask: ${text}` },
                            { inline_data: { mime_type: "image/jpeg", data: imageBase64 } }
                        ]
                    }]
                })
            });
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis fail";
        }

        // ==========================================
        // ğŸ—£ï¸ VOICE & COMMANDS
        // ==========================================
        function startVoice() {
            if(!('webkitSpeechRecognition' in window)) return alert("Speech support nathi");
            const rec = new webkitSpeechRecognition();
            rec.lang = 'gu-IN';
            rec.interimResults = false;
            rec.onstart = () => { updateStatus("Listening", "listening"); micBtn.classList.add('listening'); };
            rec.onend = () => { micBtn.classList.remove('listening'); updateStatus("Idle", "idle"); };
            rec.onresult = async (e) => {
                const transcript = e.results[0][0].transcript;
                console.log("Voice Input:", transcript);
                updateStatus("Thinking", "processing");
                await processCommand(transcript);
            };
            rec.start();
        }

        function stopAll() { window.speechSynthesis.cancel(); updateStatus("Idle", "idle"); }

        function speak(text) {
            window.speechSynthesis.cancel();
            // APPLY CLEANUP HERE
            const cleanText = cleanTextForSpeech(text); 
            console.log("Speaking:", cleanText);
            
            const u = new SpeechSynthesisUtterance(cleanText);
            u.lang = 'gu-IN';
            u.rate = 1;
            u.onstart = () => updateStatus("Speaking", "speaking");
            u.onend = () => updateStatus("Idle", "idle");
            window.speechSynthesis.speak(u);
        }

        // ==========================================
        // ğŸ§  SMART PROCESSING
        // ==========================================
        async function processCommand(text) {
            const lower = text.toLowerCase();

            // 1. MEMORY LOGIC (NEW)
            if (lower.includes('àª¯àª¾àª¦') && lower.includes('àª°àª¾àª–')) {
                const fact = text.replace(/àª¯àª¾àª¦.*?àª°àª¾àª–/g, '').trim();
                if(fact.length > 2) {
                    addMemory(fact);
                    speak("àª®àª¨à«‡ àª¯àª¾àª¦ àª°àª¹à«€ àª—àª¯à«àª‚: " + fact);
                } else {
                    speak("àª¯àª¾àª¦ àª°àª¾àª–àªµàª¾ àª®àª¾àªŸà«‡ àª•àª‚àªˆàª• àª•àª¹à«‹.");
                }
                return;
            }

            // 2. MAPS LOGIC
            if (lower.includes('àª¨àªœà«€àª•') || lower.includes('near') || lower.includes('maps') || lower.includes('àª¶à«‹àª§à«‹')) {
                let searchQuery = text.replace(/àª¨àªœà«€àª•|near|àª®àª¾àª°à«€|àª®àª¾àª°àª¾|àª¶à«‹àª§à«‹|find/g, '').trim();
                if(searchQuery.length > 0) {
                    speak(`${searchQuery} àª¶à«‹àª§à«€ àª°àª¹à«àª¯à«‹ àª›à«àª‚`);
                    openMapSearch(searchQuery);
                } else speak("àª¶à«àª‚ àª¶à«‹àª§àªµà«àª‚ àª›à«‡ àª•àª¹à«‹.");
                return;
            }

            // 3. MESSAGING LOGIC
            if(lower.includes('àª®à«‡àª¸à«‡àªœ') || lower.includes('message')) {
                let potentialName = text.replace(/àª®à«‡àª¸à«‡àªœ|message|àª•àª°à«‹|karo|àª•àª°|kar|àª¨à«‡|ne/g, '').trim();
                const contact = findContact(potentialName);
                if(contact) { speak(`${contact.name} àª¨à«‡ WhatsApp àª–à«‹àª²à«€ àª°àª¹à«àª¯à«‹ àª›à«àª‚`); setTimeout(() => openWa(contact.number), 2000); }
                else speak(`àª®àª¾àª°à«€ àªªàª¾àª¸à«‡ ${potentialName} àª¨à«‹ àª¨àª‚àª¬àª° àª¨àª¥à«€.`);
                return;
            }

            // 4. CALL LOGIC
            if(lower.includes('àª•à«‰àª²') || lower.includes('call')) {
                const number = extractNumber(text);
                if(number) { speak(number + " àªªàª° àª•à«‰àª² àª•àª°à«€ àª°àª¹à«àª¯à«‹ àª›à«àª‚"); setTimeout(() => openCall(number), 2000); return; }
                
                let potentialName = text.replace(/àª•à«‰àª²|call|àª•àª°à«‹|karo|àª•àª°|kar|àª¨à«‡|ne|àª¨à«‚àª‚|nu|àªªàª°|par/g, '').trim();
                if(potentialName.length > 0) {
                    const contact = findContact(potentialName);
                    if(contact) { speak(`${contact.name} àª¨à«‡ àª•à«‰àª² àª•àª°à«€ àª°àª¹à«àª¯à«‹ àª›à«àª‚`); setTimeout(() => openCall(contact.number), 2000); }
                    else speak(`àª®àª¾àª°à«€ àªªàª¾àª¸à«‡ ${potentialName} àª¨à«‹ àª¨àª‚àª¬àª° àª¨àª¥à«€.`);
                } else speak("àª•à«‰àª² àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àª¨àª¾àª® àª…àª¥àªµàª¾ àª¨àª‚àª¬àª° àª•àª¹à«‹.");
                return;
            }

            // 5. NOTE
            if(lower.includes('àª¨à«‹àª‚àª§') || lower.includes('note')) {
                const noteText = text.replace(/àª¨à«‹àª‚àª§.*?àª²àª–à«‹|note.*?down/gi, '').trim();
                if(noteText.length > 0) { saveNote(noteText); speak("Note lidhi: " + noteText); }
                else speak("Shu lakhvu?");
                return;
            }

            // 6. General AI
            const response = await callAI(text);
            speak(response);
        }

        function extractNumber(text) {
            const gujMap = {'à«¦':'0','à«§':'1','à«¨':'2','à«©':'3','à«ª':'4','à««':'5','à«¬':'6','à«­':'7','à«®':'8','à«¯':'9'};
            let normalized = text.split('').map(c => gujMap[c] || c).join('');
            const match = normalized.match(/\d{10}/);
            return match ? match[0] : null;
        }

        // ==========================================
        // ğŸ—ºï¸ MAPS LOGIC
        // ==========================================
        function openMapSearch(query) {
            if (!navigator.geolocation) { speak("àª† àª¬à«àª°àª¾àª‰àªàª°àª®àª¾àª‚ àª²à«‹àª•à«‡àª¶àª¨ àª¸àªªà«‹àª°à«àªŸ àª¨àª¥à«€."); return; }

            speak("àª¤àª®àª¾àª°à«àª‚ àª²à«‹àª•à«‡àª¶àª¨ àª²àªˆ àª°àª¹à«àª¯à«‹ àª›à«àª‚...");

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const url = `https://www.google.com/maps/search/${encodeURIComponent(query)}/@${lat},${lng},14z`;
                    window.open(url, '_blank');
                    speak("àª¨àª•àª¶à«‹ àª–à«‹àª²à«€ àª¦à«€àª§à«‹ àª›à«‡.");
                },
                (error) => {
                    console.error("Geo Error:", error);
                    speak("àª²à«‹àª•à«‡àª¶àª¨ àª®à«‡àª³àªµàªµàª¾àª®àª¾àª‚ àª­à«‚àª³.");
                    window.open(`https://www.google.com/maps/search/${encodeURIComponent(query)}`, '_blank');
                }
            );
        }

        function openCall(num) { window.location.href = `tel:${num}`; }
        function openWa(num) { window.open(`https://wa.me/${num}`, '_blank'); }

        // ==========================================
        // ğŸ“’ NOTES
        // ==========================================
        function openNotes() { toggleSettings(); renderNotes(); document.getElementById('notesModal').classList.add('active'); }
        function toggleNotes() { document.getElementById('notesModal').classList.remove('active'); }
        function saveNote(text) {
            notes.unshift({ text: text, date: new Date().toLocaleString('gu-IN') });
            localStorage.setItem('myNotes', JSON.stringify(notes));
            showToast("Saved!");
        }
        function addManualNote() {
            const input = document.getElementById('manualNote');
            if(input.value.trim()) { saveNote(input.value.trim()); input.value = ''; renderNotes(); }
        }
        function renderNotes() {
            const container = document.getElementById('notesList');
            container.innerHTML = '';
            if(notes.length === 0) container.innerHTML = '<div style="text-align:center; color:#777;">No Notes</div>';
            else notes.forEach(n => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<span style="color:#aaa; font-size:10px">${n.date}</span><br>${n.text}`;
                container.appendChild(div);
            });
        }

        // Init
        updateModels();
        setVideo('silent');
    </script>
</body>
</html>
