<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI - Secure Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #6366f1; --accent: #f43f5e; --bg: #0f172a; }
        body { background: var(--bg); color: white; font-family: 'Poppins', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; position: relative; overflow: hidden; }
        
        #video-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.2; }

        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 25px; width: 100%; max-width: 700px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 1; }
        
        /* Settings Icon */
        .settings-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #94a3b8; transition: 0.3s; z-index: 10; }
        .settings-icon:hover { color: white; transform: rotate(90deg); }

        /* Settings Modal */
        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--primary); }
        .modal-content input { width: 100%; padding: 12px; margin: 15px 0; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: #34d399; outline: none; box-sizing: border-box; }

        textarea { width: 100%; height: 80px; background: rgba(15, 23, 42, 0.5); border: 2px solid #334155; border-radius: 16px; padding: 15px; color: #34d399; font-size: 16px; resize: none; outline: none; box-sizing: border-box; }
        .controls { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-build { background: var(--primary); color: white; }
        .btn-mic { background: #334155; color: white; width: 60px; flex: 0; }
        .btn-mic.listening { background: var(--accent); animation: pulse 1.5s infinite; }
        
        #renderArea { width: 100%; height: 400px; background: white; border-radius: 20px; margin-top: 20px; border: 5px solid #1e293b; overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <video autoplay loop muted playsinline id="video-background">
        <source src="videos/smiling_video.mp4" type="video/mp4">
    </video>

    <i class="fas fa-cog settings-icon" onclick="openSettings()"></i>

    <div class="glass-card">
        <center>
            <h1 style="background: linear-gradient(to right, #818cf8, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin:0;">વિદુષી AI બિલ્ડર</h1>
            <p style="color: #64748b; margin-bottom: 15px;">Gemini 2.5 Flash + Security Mode</p>
        </center>

        <textarea id="userCommand" placeholder="તમારો આદેશ બોલો અથવા લખો..."></textarea>
        
        <div class="controls">
            <button id="micBtn" class="btn btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="btn btn-build" onclick="buildApp()">બનાવો <i class="fas fa-magic"></i></button>
        </div>

        <div id="status" style="margin: 10px 0; font-size: 14px; color: #94a3b8;">રેડી ટુ હેલ્પ...</div>
        
        <div id="renderArea"><iframe id="appFrame"></iframe></div>
    </div>

    <div id="settingsModal">
        <div class="modal-content">
            <h3><i class="fas fa-key"></i> API સેટિંગ્સ</h3>
            <p style="font-size: 12px; color: #94a3b8;">તમારી Gemini API Key અહીં સુરક્ષિત રીતે સેવ કરો</p>
            <input type="password" id="apiKeyInput" placeholder="અહીં તમારી API Key પેસ્ટ કરો">
            <button class="btn btn-build" onclick="saveSettings()">સેવ કરો</button>
            <button style="background:none; border:none; color:#f43f5e; margin-top:10px; cursor:pointer;" onclick="closeSettings()">બંધ કરો</button>
        </div>
    </div>

    <script>
        const videoBg = document.getElementById('video-background');
        const videoSources = {
            'smiling': 'videos/smiling_video.mp4',
            'thinking': 'videos/thinking_video.mp4',
            'talking': 'videos/talking_video.mp4',
            'silent': 'videos/silent_video.mp4'
        };

        function playVideo(state) {
            if (videoSources[state]) {
                videoBg.src = videoSources[state];
                videoBg.load();
                videoBg.play();
            }
        }

        // --- Settings Logic ---
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
        
        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value;
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert("API Key સફળતાપૂર્વક સેવ થઈ ગઈ છે");
                closeSettings();
            }
        }

        // --- Gemini logic with LocalStorage ---
        async function buildApp() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (!savedKey) {
                alert("પહેલા સેટિંગ્સમાં જઈને API Key સેવ કરો");
                openSettings();
                return;
            }

            const command = document.getElementById('userCommand').value;
            const status = document.getElementById('status');
            const frame = document.getElementById('appFrame');
            if (!command) return;

            status.innerHTML = "⏳ પ્રોસેસિંગ...";
            playVideo('thinking');

            const URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${savedKey}`;

            try {
                const response = await fetch(URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Create a single-file HTML/CSS/JS tool for: ${command}. ONLY code.` }] }]
                    })
                });

                const data = await response.json();
                let aiCode = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiCode) {
                    aiCode = aiCode.replace(/```html/g, "").replace(/```/g, "");
                    status.innerHTML = "✅ એપ તૈયાર છે!";
                    playVideo('smiling');
                    const doc = frame.contentWindow.document;
                    doc.open(); doc.write(aiCode); doc.close();
                } else {
                    status.innerHTML = "❌ કી ખોટી છે અથવા ક્વોટા પૂરો થયો છે";
                    playVideo('silent');
                }
            } catch (err) {
                status.innerHTML = "❌ ભૂલ આવી";
                playVideo('silent');
            }
        }

        // Voice logic (as per previous instructions)
        function toggleMic() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'gu-IN';
            recognition.onstart = () => { playVideo('talking'); document.getElementById('micBtn').classList.add('listening'); };
            recognition.onend = () => { playVideo('smiling'); document.getElementById('micBtn').classList.remove('listening'); };
            recognition.onresult = (e) => { document.getElementById('userCommand').value = e.results[0][0].transcript; };
            recognition.start();
        }
    </script>
</body>
</html>
