<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divinity AI - Universal Oracle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --accent: #f43f5e; --glass: rgba(0, 0, 0, 0.7); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Poppins', sans-serif; background: black; color: white; }

        #video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }

        .controls-overlay { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 20px; z-index: 10; }
        .btn-mic { width: 75px; height: 75px; background: white; color: black; border: none; border-radius: 50%; font-size: 30px; cursor: pointer; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        .btn-mic.listening { background: var(--accent); color: white; animation: pulse 1.5s infinite; }
        .btn-stop { width: 55px; height: 55px; background: #ef4444; color: white; border: none; border-radius: 50%; font-size: 22px; cursor: pointer; }

        .settings-btn { position: fixed; top: 20px; right: 20px; z-index: 10; font-size: 26px; color: rgba(255,255,255,0.6); cursor: pointer; }

        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .settings-content { background: #1e293b; padding: 30px; border-radius: 28px; width: 85%; max-width: 380px; max-height: 85vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
        
        .setting-section { margin-bottom: 25px; }
        h3 { font-size: 13px; color: #818cf8; margin-bottom: 12px; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: #34d399; border-radius: 12px; margin-bottom: 12px; box-sizing: border-box; }
        
        #cameraPreview { width: 100%; height: 180px; background: black; border-radius: 15px; display: none; object-fit: cover; }

        #reportModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 80%; background: #111827; color: white; border-radius: 24px; z-index: 200; padding: 25px; overflow-y: auto; border: 1px solid #4f46e5; }
        .report-body { line-height: 1.6; font-size: 15px; color: #e5e7eb; white-space: pre-wrap; margin-top: 20px; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <video autoplay loop muted playsinline id="video-background">
        <source src="smiling.mp4" type="video/mp4">
    </video>

    <i class="fas fa-cog settings-btn" onclick="toggleSettings()"></i>

    <div class="controls-overlay">
        <button class="btn-stop" onclick="stopAll()"><i class="fas fa-stop"></i></button>
        <button id="micBtn" class="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
    </div>

    <div id="settingsModal">
        <div class="settings-content">
            <h2 style="text-align:center; color:white;">Divinity Settings</h2>
            
            <div class="setting-section">
                <h3>Knowledge Base (RAG)</h3>
                <input type="file" id="ragFileUpload" accept=".txt" onchange="handleRAGUpload(event)">
                <p id="fileStatus" style="font-size:10px; color:#94a3b8;"></p>
            </div>

            <div class="setting-section">
                <h3>Smart Lens (Back Camera)</h3>
                <button onclick="toggleCamera()" style="width:100%; padding:12px; background:#334155; color:white; border:none; border-radius:12px; cursor:pointer;"><i class="fas fa-camera"></i> On/Off Camera</button>
                <video id="cameraPreview" autoplay playsinline style="margin-top:10px;"></video>
                <button id="analyzeBtn" onclick="analyzeVision()" style="width:100%; padding:12px; background:#818cf8; color:white; border:none; border-radius:12px; margin-top:10px; display:none;"><i class="fas fa-search"></i> Analysis Everything</button>
            </div>

            <div class="setting-section">
                <h3>Configuration</h3>
                <input type="password" id="geminiKey" placeholder="Gemini API Key">
                <button onclick="saveSettings()" style="width:100%; padding:14px; background:#4f46e5; color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">Save All</button>
            </div>
            <p onclick="toggleSettings()" style="text-align:center; color:#94a3b8; cursor:pointer;">Close</p>
        </div>
    </div>

    <div id="reportModal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="reportTitle" style="color:#818cf8;">Analysis Report</h2>
            <div style="display:flex; gap:10px;">
                <button onclick="downloadReport()" style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Download</button>
                <button onclick="closeReport()" style="background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">X</button>
            </div>
        </div>
        <div id="reportContent" class="report-body">Generating...</div>
    </div>

    <script>
        const videoBg = document.getElementById('video-background');
        let ragData = localStorage.getItem('rag_data') || "";

        function playVideo(state) {
            videoBg.src = state + '.mp4';
            videoBg.load();
            videoBg.play().catch(e => {});
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function handleRAGUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    ragData = e.target.result;
                    localStorage.setItem('rag_data', ragData);
                    document.getElementById('fileStatus').innerText = "Knowledge Loaded: " + file.name;
                };
                reader.readAsText(file);
            }
        }

        function saveSettings() {
            localStorage.setItem('gemini_key', document.getElementById('geminiKey').value);
            alert("Settings Saved Permanently!");
            toggleSettings();
        }

        async function toggleCamera() {
            const video = document.getElementById('cameraPreview');
            const btn = document.getElementById('analyzeBtn');
            if (video.style.display === 'block') {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.style.display = 'none';
                btn.style.display = 'none';
            } else {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.style.display = 'block';
                btn.style.display = 'block';
            }
        }

        async function analyzeVision() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64Img = canvas.toDataURL('image/jpeg').split(',')[1];

            document.getElementById('reportModal').style.display = 'block';
            playVideo('thinking');

            const key = localStorage.getItem('gemini_key');
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;

            const prompt = `તમે Divinity છો, જેને દેવેન્દ્રભાઈએ બનાવી છે. કેમેરામાં દેખાતી લિપિ, ગણિતના દાખલા કે કોઈપણ વસ્તુનું વિશ્લેષણ કરી ગુજરાતીમાં વિગતવાર રિપોર્ટ આપો. જવાબમાં ક્યાંય પણ વિશેષ ચિન્હો જેમ કે *, ", 0 વગેરેનો ઉપયોગ બોલવા માટે કરવો નહીં.`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt + "\nContext Knowledge: " + ragData }, { inline_data: { mime_type: "image/jpeg", data: base64Img } }] }]
                    })
                });
                const data = await res.json();
                const result = data.candidates[0].content.parts[0].text;
                document.getElementById('reportContent').innerText = result;
                playVideo('smiling');
            } catch (e) { document.getElementById('reportContent').innerText = "Error: " + e.message; playVideo('silent'); }
        }

        function stopAll() { playVideo('smiling'); document.getElementById('micBtn').classList.remove('listening'); }

        function toggleMic() {
            const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.lang = 'gu-IN';
            rec.onstart = () => { playVideo('talking'); document.getElementById('micBtn').classList.add('listening'); };
            rec.onend = () => { document.getElementById('micBtn').classList.remove('listening'); playVideo('smiling'); };
            rec.onresult = (e) => { processVoice(e.results[0][0].transcript); };
            rec.start();
        }

        async function processVoice(q) {
            // Voice processing logic with Divinity and Devenbhai context
            console.log("Processing Query:", q);
        }

        function downloadReport() {
            const blob = new Blob([document.getElementById('reportContent').innerText], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Divinity_Report.txt'; a.click();
        }

        function closeReport() { document.getElementById('reportModal').style.display = 'none'; }

        window.onload = () => {
            document.getElementById('geminiKey').value = localStorage.getItem('gemini_key') || "";
            if(ragData) document.getElementById('fileStatus').innerText = "Knowledge base is active";
        };
    </script>
</body>
</htmlogicic
