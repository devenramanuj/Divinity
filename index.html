<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Divinity AI - ркЬркп рк╕рлАркпрк╛рк░рк╛рко</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #f43f5e; 
            --glass: rgba(0, 0, 0, 0.9);
            --saffron: #FF9933;
            --green: #138808;
            --pink: #ec4899;
            --purple: #8b5cf6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body, html { 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background: #000; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }
        
        #mainVideo { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: 1; 
        }
        
        .ui-layer { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        /* Top Status Bar */
        .status-bar {
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        
        #status { 
            color: var(--pink); 
            font-size: 16px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .setting-icon {
            font-size: 24px; 
            color: var(--pink); 
            cursor: pointer;
            background: rgba(0,0,0,0.7);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .setting-icon:hover, .setting-icon:active {
            background: rgba(0,0,0,0.9);
            transform: rotate(45deg);
        }
        
        /* Bottom Controls */
        .bottom-controls {
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }
        
        .controls { 
            display: flex; 
            align-items: center; 
            gap: 30px; 
            background: rgba(0,0,0,0.85); 
            padding: 15px 30px; 
            border-radius: 50px; 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 250px;
            justify-content: center;
        }
        
        .btn-mic { 
            width: 80px; 
            height: 80px; 
            background: linear-gradient(135deg, var(--pink), var(--purple)); 
            border: none; 
            border-radius: 50%; 
            font-size: 28px; 
            cursor: pointer; 
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(236, 72, 153, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-mic:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.4);
        }
        
        .btn-mic.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #ef4444, var(--pink));
        }
        
        .btn-stop { 
            width: 60px; 
            height: 60px; 
            background: #ef4444; 
            border: none; 
            border-radius: 50%; 
            color: #fff; 
            cursor: pointer; 
            font-size: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-stop:active {
            transform: scale(0.95);
            background: #dc2626;
        }
        
        /* Modal Styles */
        #settingsModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.97); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-card { 
            background: #1e293b; 
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            padding: 25px; 
            border-radius: 20px; 
            border: 2px solid var(--pink); 
            color: #fff; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            overflow-y: auto;
        }
        
        .modal-title {
            text-align: center;
            color: var(--pink);
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            color: #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            min-width: 120px;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: var(--pink);
            color: white;
            border-color: var(--pink);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            margin-top: 8px; 
            margin-bottom: 15px;
            background: #0f172a; 
            border: 1px solid #334155; 
            color: #34d399; 
            border-radius: 12px; 
            font-size: 16px;
            font-family: inherit;
        }
        
        label {
            color: #cbd5e1;
            font-size: 14px;
            margin-left: 5px;
            display: block;
            margin-bottom: 5px;
        }
        
        #camBox { 
            width: 100%; 
            height: 200px; 
            background: #000; 
            border-radius: 15px; 
            margin-top: 15px; 
            margin-bottom: 15px;
            display: none; 
            border: 2px solid var(--pink); 
            overflow: hidden; 
            position: relative; 
        }
        
        #videoFeed { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .modal-button {
            width: 100%; 
            padding: 15px; 
            margin-top: 10px; 
            background: linear-gradient(135deg, var(--purple), var(--pink)); 
            color: #fff; 
            border-radius: 12px; 
            font-weight: bold;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-button:active {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(139, 92, 246, 0.4);
        }
        
        .close-btn {
            text-align: center; 
            color: #ef4444; 
            cursor: pointer; 
            margin-top: 20px;
            font-weight: bold;
            padding: 10px;
        }
        
        .close-btn:active {
            color: #dc2626;
        }
        
        /* Diary Styles */
        .diary-entry {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .diary-date {
            color: var(--pink);
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .diary-content {
            color: #e2e8f0;
            line-height: 1.5;
        }
        
        /* Vanshavali Styles */
        .family-tree-container {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .vanshavali-message {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }
        
        .tree-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tree-btn {
            flex: 1;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #334155;
            color: #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .tree-btn:hover {
            background: var(--pink);
            color: white;
        }
        
        /* Loading Overlay */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000428, #004e92);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }
        
        .welcome-text {
            color: var(--pink);
            margin-bottom: 10px;
            animation: fadeIn 2s ease;
            text-align: center;
            padding: 0 20px;
            font-size: 32px;
            font-weight: bold;
        }
        
        .subtitle {
            font-size: 18px; 
            color: #ccc; 
            text-align: center; 
padding: 0 20px;
            margin-bottom: 30px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .controls {
                gap: 25px;
                padding: 15px 25px;
            }
            
            .btn-mic {
                width: 70px;
                height: 70px;
                font-size: 26px;
            }
            
            .btn-stop {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
            
            #status {
                font-size: 14px;
                padding: 8px 16px;
                max-width: 65%;
            }
            
            .setting-icon {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }
            
            .modal-card {
                padding: 20px;
                border-radius: 15px;
            }
            
            .modal-title {
                font-size: 20px;
            }
        }
        
        @media (max-width: 360px) {
            .controls {
                gap: 20px;
                padding: 12px 20px;
            }
            
            .btn-mic {
                width: 65px;
                height: 65px;
                font-size: 24px;
            }
            
            .btn-stop {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <video id="mainVideo" autoplay loop muted playsinline>
        <source src="silent.mp4" type="video/mp4">
    </video>
    
    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-text">Divinity AI</div>
        <div class="subtitle">ркдркорк╛рк░рлА рк╡рлНркпркХрлНркдрк┐ркЧркд рк╕рк╣рк╛ркпркХ</div>
        <div style="font-size: 16px; color: #aaa; text-align: center; padding: 0 20px; margin-top: 20px;">
            рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлБркВ ркЫрлЗ... тП│
        </div>
    </div>

    <div class="ui-layer">
        <!-- Top Status Bar -->
        <div class="status-bar">
            <div id="status">ЁЯС╕ Divinity ркдрлИркпрк╛рк░ ркЫрлЗ</div>
            <div class="setting-icon" onclick="toggleModal('settingsModal')">
                <i class="fas fa-cog"></i>
            </div>
        </div>
        
        <!-- Bottom Controls -->
        <div class="bottom-controls">
            <div class="controls">
                <button class="btn-stop" onclick="stopEverything()" title="ркмркВркз ркХрк░рлЛ" id="stopButton">
                    <i class="fas fa-stop"></i>
                </button>
                <button id="micBtn" class="btn-mic" onclick="startInteraction()" title="ркмрлЛрк▓рлЛ">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal">
        <div class="modal-card">
            <div class="modal-title">ЁЯСС Divinity рк╕рлЗркЯрк┐ркВркЧрлНрк╕</div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('aiTab')">AI рк╕рлЗркЯрк┐ркВркЧрлНрк╕</button>
                <button class="tab-btn" onclick="switchTab('diaryTab')">ЁЯУЦ ркбрк╛ркпрк░рлА</button>
                <button class="tab-btn" onclick="switchTab('vanshavaliTab')">ЁЯМ│ рк╡ркВрк╢рк╛рк╡рк│рлА</button>
                <button class="tab-btn" onclick="switchTab('cameraTab')">ЁЯУ╖ ркХрлЕркорлЗрк░рк╛</button>
            </div>
            
            <!-- AI Settings Tab -->
            <div id="aiTab" class="tab-content active">
                <label for="activeModel">AI ркорлЛркбрк▓ рккрк╕ркВркж ркХрк░рлЛ</label>
                <select id="activeModel">
                    <option value="groq">Groq Llama 3 (70B)</option>
                    <option value="gemini">Gemini 2.0 Flash</option>
                </select>
                
                <label for="geminiKeys">Gemini API ркХрлА (ркХрлЛркорк╛ рк╡ркбрлЗ ркЕрк▓ркЧ)</label>
                <textarea id="geminiKeys" rows="2" placeholder="AIzaSy..."></textarea>
                
                <label for="groqKey">Groq API ркХрлА</label>
                <input type="password" id="groqKey" placeholder="gsk_...">
                
                <button class="modal-button" onclick="saveConfig()">
                    <i class="fas fa-save"></i> ркмркзрлБркВ рк╕ркВркЧрлНрк░рк╣рлЛ
                </button>
            </div>
            
            <!-- Diary Tab -->
            <div id="diaryTab" class="tab-content">
                <h3 style="color: var(--pink); margin-bottom: 15px; text-align: center;">ЁЯУЦ ркорк╛рк░рлА ркбрк╛ркпрк░рлА</h3>
                
                <div style="margin-bottom: 20px;">
                    <label for="newDiaryEntry">ркирк╡рлА ркирлЛркВркз ркЙркорлЗрк░рлЛ</label>
                    <textarea id="newDiaryEntry" rows="4" placeholder="ркЖркЬрлЗ ркорлЗркВ рк╢рлБркВ ркХрк░рлНркпрлБркВ?"></textarea>
                    <button class="modal-button" onclick="addDiaryEntry()" style="background: linear-gradient(135deg, var(--green), #10b981);">
                        <i class="fas fa-plus"></i> ркирлЛркВркз ркЙркорлЗрк░рлЛ
                    </button>
                </div>
                
                <div id="diaryEntries">
                    <!-- Diary entries will be loaded here -->
                </div>
            </div>
            
            <!-- Vanshavali Tab -->
            <div id="vanshavaliTab" class="tab-content">
                <h3 style="color: var(--pink); margin-bottom: 15px; text-align: center;">ЁЯМ│ ркдркорк╛рк░рлА рк╡ркВрк╢рк╛рк╡рк│рлА</h3>
                
                <div id="familyTreeDisplay" class="family-tree-container">
                    <div class="vanshavali-message">
                        <i class="fas fa-tree" style="font-size: 40px; color: var(--green); margin-bottom: 15px;"></i>
                        <p>рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркеркИ рк░рк╣рлНркпрлЛ ркЫрлЗ...</p>
                        <p style="font-size: 14px; margin-top: 10px;">vanshavali_data.js рклрк╛ркИрк▓ рк▓рлЛркб ркХрк░рк╡рк╛ркорк╛ркВ</p>
                    </div>
                </div>
                
                <button class="modal-button" onclick="loadVanshavaliData()" style="background: linear-gradient(135deg, var(--purple), var(--saffron)); margin-top: 10px;">
                    <i class="fas fa-sync-alt"></i> рк╡ркВрк╢рк╛рк╡рк│рлА рклрк░рлАркерлА рк▓рлЛркб ркХрк░рлЛ
                </button>
            </div>
            
            <!-- Camera Tab -->
            <div id="cameraTab" class="tab-content">
                <h3 style="color: var(--pink); margin-bottom: 15px; text-align: center;">ЁЯУ╖ ркХрлЕркорлЗрк░рк╛</h3>
                
                <div style="margin-bottom: 20px;">
                    <button class="modal-button" onclick="startCamera()">
                        <i class="fas fa-camera"></i> ркХрлЕркорлЗрк░рк╛ ркЪрк╛рк▓рлБ ркХрк░рлЛ
                    </button>
                    
                    <button class="modal-button" onclick="stopCamera()" style="margin-top: 10px; background: linear-gradient(135deg, #ef4444, #dc2626);">
                        <i class="fas fa-stop-circle"></i> ркХрлЕркорлЗрк░рк╛ ркмркВркз ркХрк░рлЛ
                    </button>
                </div>
                
                <div id="camBox">
                    <video id="videoFeed" autoplay playsinline></video>
                    <button class="modal-button" onclick="captureAndAnalyze()" style="position:absolute; bottom:10px; left:5%; width:90%; background: linear-gradient(135deg, var(--green), #3b82f6);">
                        <i class="fas fa-eye"></i> рклрлЛркЯрлЛ рк▓ркИ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг ркХрк░рлЛ
                    </button>
                </div>
                
                <p style="color: #94a3b8; font-size: 14px; text-align: center; margin-top: 15px;">
                    ЁЯУ╕ рккрк╣рлЗрк▓рк╛ "ркХрлЕркорлЗрк░рк╛ ркЪрк╛рк▓рлБ ркХрк░рлЛ" ркмркЯрки ркжркмрк╛рк╡рлЛ, рккркЫрлА рклрлЛркЯрлЛ рк▓ркИ рк╢ркХрлЛ ркЫрлЛ
                </p>
            </div>
            
            <div class="close-btn" onclick="toggleModal('settingsModal')">
                <i class="fas fa-times"></i> ркмркВркз ркХрк░рлЛ
            </div>
        </div>
    </div>

    <!-- External Vanshavali Data File -->
    <script src="vanshavali_data.js"></script>

    <script>
        // тЬЕ FIX 1: Variables declaration
        const videoStates = {
            'silent': 'silent.mp4',
            'talking': 'talking.mp4', 
            'thinking': 'thinking.mp4',
            'smiling': 'smiling.mp4'
        };
        
        let diaryEntries = [];
        let vanshavaliData = null;
        let cameraStream = null;
        let isSpeaking = false;
        let isListening = false;

        // тЬЕ FIX 2: Set video function
        function setVideo(state) {
            const video = document.getElementById('mainVideo');
            const status = document.getElementById('status');
            
            if(videoStates[state]) {
                video.src = videoStates[state];
                video.play().catch(e => console.log("Video error:", e));
                
                switch(state) {
                    case 'talking':
                        status.textContent = "ЁЯОд Divinity ркмрлЛрк▓рлЗ ркЫрлЗ...";
                        status.style.color = "#34d399";
                        break;
                    case 'thinking':
                        status.textContent = "ЁЯдФ Divinity рк╡рк┐ркЪрк╛рк░рлЗ ркЫрлЗ...";
                        status.style.color = "#3b82f6";
                        break;
                    case 'silent':
                        status.textContent = "ЁЯС╕ Divinity ркдрлИркпрк╛рк░ ркЫрлЗ";
                        status.style.color = "var(--pink)";
                        break;
                    case 'smiling':
                        status.textContent = "ЁЯШК Divinity ркдркорк╛рк░рлБркВ рк╕рлНрк╡рк╛ркЧркд ркХрк░рлЗ ркЫрлЗ";
                        status.style.color = "var(--pink)";
                        break;
                }
            }
        }

        // тЬЕ FIX 3: Modal functions
        function toggleModal(id) {
            const modal = document.getElementById(id);
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
                stopCamera();
            } else {
                modal.style.display = 'flex';
                if (id === 'settingsModal') {
                    loadDiaryEntries();
                    loadVanshavaliData();
                }
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Stop camera when switching tabs
            if (tabId !== 'cameraTab') {
                stopCamera();
            }
        }

        // тЬЕ FIX 4: Camera functions - WORKING VERSION
        async function startCamera() {
            const box = document.getElementById('camBox');
            const feed = document.getElementById('videoFeed');
            
            try {
                // Stop existing stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Request camera access
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                feed.srcObject = cameraStream;
                box.style.display = 'block';
                
                // Play video
                feed.onloadedmetadata = () => {
                    feed.play();
                    speak("ркХрлЕркорлЗрк░рк╛ ркЪрк╛рк▓рлБ ркеркИ ркЧркИ ркЫрлЗ");
                };
                
            } catch (error) {
                console.error("Camera error:", error);
                let errorMsg = "ркХрлЕркорлЗрк░рк╛ ркорк╛ркЯрлЗ рккрк░рк╡рк╛ркиркЧрлА ркЖрккрлЛ";
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg = "ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркмрлНрк░рк╛ркЙркЭрк░ рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВ ркХрлЕркорлЗрк░рк╛ рккрк░рк╡рк╛ркиркЧрлА ркЖрккрлЛ";
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMsg = "ркХрлЛркИ ркХрлЕркорлЗрк░рк╛ ркорк│рлНркпрлЛ ркиркерлА";
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMsg = "ркХрлЕркорлЗрк░рк╛ рк╡рккрк░рк╛рк╢ркорк╛ркВ ркЫрлЗ";
                }
                
                alert(errorMsg);
                speak("ркХрлЕркорлЗрк░рк╛ ркЪрк╛рк▓рлБ ркХрк░рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркЖрк╡рлА ркЫрлЗ");
            }
        }

        function stopCamera() {
            const box = document.getElementById('camBox');
            const feed = document.getElementById('videoFeed');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            feed.srcObject = null;
            box.style.display = 'none';
        }

        async function captureAndAnalyze() {
            const video = document.getElementById('videoFeed');
            
            if (!video.srcObject) {
                speak("рккрк╣рлЗрк▓рк╛ ркХрлЕркорлЗрк░рк╛ ркЪрк╛рк▓рлБ ркХрк░рлЛ");
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];
            
            speak("рклрлЛркЯрлЛ рк▓ркИ рк░рк╣рлНркпрк╛ ркЫрлАркП ркЕркирлЗ рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг ркХрк░рлАркП ркЫрлАркП");
            
            setTimeout(async () => {
                const analysis = await fetchAI("ркЖ рклрлЛркЯрк╛ркорк╛ркВ рк╢рлБркВ ркЫрлЗ? рк╡рк┐ркЧркдрк╡рк╛рк░ рк╡рк░рлНркгрки ркХрк░рлЛ.", imageBase64);
                speak(analysis);
            }, 1000);
        }

        // тЬЕ FIX 5: Stop button - WORKING VERSION
        function stopEverything() {
            console.log("Stop button clicked");
            
            // Stop speaking
            window.speechSynthesis.cancel();
            isSpeaking = false;
            
            // Stop listening
            if (isListening) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    try {
                        recognition.stop();
                    } catch(e) {}
                }
                isListening = false;
            }
            
            // Remove listening class
            document.getElementById('micBtn').classList.remove('listening');
            
            // Stop camera
            stopCamera();
            
            // Set silent video
            setVideo('silent');
            
            // Show confirmation
            const status = document.getElementById('status');
            status.textContent = "тП╣я╕П ркмркВркз ркХрк░рлНркпрлБркВ";
            status.style.color = "#ef4444";
            
            setTimeout(() => {
                status.textContent = "ЁЯС╕ Divinity ркдрлИркпрк╛рк░ ркЫрлЗ";
                status.style.color = "var(--pink)";
            }, 2000);
            
            // Visual feedback
            const stopBtn = document.getElementById('stopButton');
            stopBtn.style.background = "#10b981";
            setTimeout(() => {
                stopBtn.style.background = "#ef4444";
            }, 500);
            
            speak("ркмркзрлБркВ ркмркВркз ркХрк░рлНркпрлБркВ");
        }

        // тЬЕ FIX 6: Speak function
        function speak(text) {
            window.speechSynthesis.cancel();
            
            const speech = new SpeechSynthesisUtterance();
            speech.text = cleanGujaratiText(text);
            speech.lang = 'gu-IN';
            speech.rate = 1.0;
            speech.pitch = 1.2;
            speech.volume = 1.0;
            
            isSpeaking = true;
            
            speech.onstart = function() {
                setVideo('talking');
                document.getElementById('micBtn').classList.add('listening');
            };
            
            speech.onend = speech.onerror = function() {
                setVideo('silent');
                document.getElementById('micBtn').classList.remove('listening');
                isSpeaking = false;
            };
            
            window.speechSynthesis.speak(speech);
        }

        function cleanGujaratiText(text) {
            return text.replace(/[^\u0A80-\u0AFFa-zA-Z0-9\s.,!?ркХрлНрк░рко]/g, ' ');
        }

        // тЬЕ FIX 7: Vanshavali data loading
        function loadVanshavaliData() {
            const treeContainer = document.getElementById('familyTreeDisplay');
            
            // Check if external file loaded
            if (typeof window.vanshavaliData !== 'undefined') {
                vanshavaliData = window.vanshavaliData;
                
                treeContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 40px; color: var(--green); margin-bottom: 15px;"></i>
                        <h4 style="color: var(--pink); margin-bottom: 10px;">${vanshavaliData.name}</h4>
                        <p style="color: #cbd5e1; margin-bottom: 15px;">${vanshavaliData.info || ''}</p>
                        <p style="color: #94a3b8; font-size: 14px;">
                            тЬЕ vanshavali_data.js рклрк╛ркИрк▓ рк╕рклрк│ркдрк╛рккрлВрк░рлНрк╡ркХ рк▓рлЛркб ркеркИ
                        </p>
                        <p style="color: #94a3b8; font-size: 14px; margin-top: 10px;">
                            ркХрлБрк▓ рк╕ркнрлНркпрлЛ: ${countTreeMembers(vanshavaliData)}
                        </p>
                    </div>
                `;
                
                console.log("тЬЕ Vanshavali data loaded from external file");
                speak("рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рк▓рлЛркб ркеркИ ркЧркпрлЛ ркЫрлЗ");
                
            } else {
                treeContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: #ef4444; margin-bottom: 15px;"></i>
                        <p style="color: #cbd5e1; margin-bottom: 10px;">vanshavali_data.js рклрк╛ркИрк▓ ркорк│рлА ркиркерлА</p>
                        <p style="color: #94a3b8; font-size: 14px;">
                            ркХрлГрккрк╛ ркХрк░рлАркирлЗ vanshavali_data.js рклрк╛ркИрк▓ index.html рк╕рк╛ркерлЗ рк╕ркорк╛рки рклрлЛрк▓рлНркбрк░ркорк╛ркВ ркорлВркХрлЛ
                        </p>
                    </div>
                `;
                
                console.error("тЭМ vanshavali_data.js file not found");
                speak("рк╡ркВрк╢рк╛рк╡рк│рлА ркбрлЗркЯрк╛ рклрк╛ркИрк▓ ркорк│рлА ркиркерлА");
            }
        }

        function countTreeMembers(node) {
            let count = 1;
            if (node.children) {
                node.children.forEach(child => {
                    count += countTreeMembers(child);
                });
            }
            return count;
        }

        // тЬЕ FIX 8: AI function
        async function fetchAI(prompt, imageBase64 = null) {
            const model = document.getElementById('activeModel').value;
            const geminiKeys = (localStorage.getItem('div_gemini_keys') || "").split(',').filter(k => k.trim());
            const groqKey = localStorage.getItem('div_groq_key');
            
            setVideo('thinking');
            
            try {
                if (model === "groq") {
                    if (!groqKey) throw new Error("Groq API ркХрлА ркорлВркХрлЛ");
                    
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${groqKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: "llama3-70b-8192",
                            messages: [{
                                role: "user",
                                content: `ркдрлБркВ ркПркХ рк╕рлНркдрлНрк░рлА AI рк╕рк╣рк╛ркпркХ ркЫрлЛ ркЬрлЗркирлБркВ ркирк╛рко Divinity ркЫрлЗ. ркдрлБркВ рк╣ркВркорлЗрк╢рк╛ рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ ркЬ ркмрлЛрк▓рлЗ ркЫрлЗ. ркирлАркЪрлЗркирк╛ рккрлНрк░рк╢рлНркиркирлЛ ркЯрлВркВркХрлЛ, рк╕рк░рк│ ркЕркирлЗ ркорлИркдрлНрк░рлАрккрлВрк░рлНркг ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркЬрк╡рк╛ркм ркЖркк (рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ):\n\n${prompt}`
                            }],
                            temperature: 0.7,
                            max_tokens: 500
                        })
                    });
                    
                    if (!response.ok) throw new Error(`Groq error: ${response.status}`);
                    const data = await response.json();
                    return data.choices[0].message.content;
                    
                } else {
                    if (!geminiKeys.length) throw new Error("Gemini API ркХрлА ркорлВркХрлЛ");
                    
                    const apiKey = geminiKeys[Math.floor(Math.random() * geminiKeys.length)];
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const parts = [{
                        text: `ркдрлБркВ ркПркХ рк╕рлНркдрлНрк░рлА AI рк╕рк╣рк╛ркпркХ ркЫрлЛ ркЬрлЗркирлБркВ ркирк╛рко Divinity ркЫрлЗ. ркдрлБркВ рк╣ркВркорлЗрк╢рк╛ рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ ркЬ ркмрлЛрк▓рлЗ ркЫрлЗ. ркирлАркЪрлЗркирк╛ рккрлНрк░рк╢рлНркиркирлЛ ркЯрлВркВркХрлЛ, рк╕рк░рк│ ркЕркирлЗ ркорлИркдрлНрк░рлАрккрлВрк░рлНркг ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркЬрк╡рк╛ркм ркЖркк (рк╕рлНркдрлНрк░рлА рк▓рк┐ркВркЧркорк╛ркВ):\n\n${prompt}`
                    }];
                    
                    if (imageBase64) {
                        parts.push({
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: imageBase64
                            }
                        });
                    }
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 500
                            }
                        })
                    });
                    
                    if (!response.ok) throw new Error(`Gemini error: ${response.status}`);
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }
            } catch (error) {
                console.error("AI ркнрлВрк▓:", error);
                return `ркорк╛ркл ркХрк░ркЬрлЛ, ркоркирлЗ рк╕ркоркЬрк╛ркпрлБркВ ркиркерлА. рк╢рлБркВ ркдркорлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рк╢рлЛ?`;
            }
        }

        // тЬЕ FIX 9: Diary functions
        function addDiaryEntry() {
            const entryText = document.getElementById('newDiaryEntry').value.trim();
            if (!entryText) {
                alert("ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркХркВркИркХ рк▓ркЦрлЛ");
                return;
            }
            
            const newEntry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('gu-IN'),
                time: new Date().toLocaleTimeString('gu-IN', { hour: '2-digit', minute: '2-digit' }),
                content: entryText
            };
            
            diaryEntries.unshift(newEntry);
            saveDiaryEntries();
            loadDiaryEntries();
            document.getElementById('newDiaryEntry').value = '';
            
            speak("ркбрк╛ркпрк░рлАркорк╛ркВ ркирлЛркВркз ркЙркорлЗрк░рлА ркЧркИ ркЫрлБркВ");
        }

        function loadDiaryEntries() {
            const entriesContainer = document.getElementById('diaryEntries');
            entriesContainer.innerHTML = '';
            
            if (diaryEntries.length === 0) {
                entriesContainer.innerHTML = '<p style="text-align:center; color:#94a3b8;">рк╣ркЬрлА ркХрлЛркИ ркирлЛркВркз ркиркерлА</p>';
                return;
            }
            
            diaryEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'diary-entry';
                entryDiv.innerHTML = `
                    <div class="diary-date">ЁЯУЕ ${entry.date} тП░ ${entry.time}</div>
                    <div class="diary-content">${entry.content}</div>
                    <button onclick="deleteDiaryEntry(${entry.id})" style="margin-top:10px; background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:5px; font-size:12px;">
                        <i class="fas fa-trash"></i> ркжрлВрк░ ркХрк░рлЛ
                    </button>
                `;
                entriesContainer.appendChild(entryDiv);
            });
        }

        function deleteDiaryEntry(id) {
            diaryEntries = diaryEntries.filter(entry => entry.id !== id);
            saveDiaryEntries();
            loadDiaryEntries();
            speak("ркирлЛркВркз ркжрлВрк░ ркХрк░рлА ркЧркИ ркЫрлБркВ");
        }

        function saveDiaryEntries() {
            localStorage.setItem('div_diary_entries', JSON.stringify(diaryEntries));
        }

        // тЬЕ FIX 10: Voice interaction
        function startInteraction() {
            if (isSpeaking) {
                speak("рк╣рлБркВ рк╣ркоркгрк╛ркВ ркЬ ркмрлЛрк▓рлА рк░рк╣рлА ркЫрлБркВ, ркПркХ ркХрлНрк╖ркг рк░рк╛рк╣ ркЬрлБркУ");
                return;
            }
            
            const micBtn = document.getElementById('micBtn');
            micBtn.classList.add('listening');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                speak("ркорк╛ркл ркХрк░ркЬрлЛ, ркЖ ркмрлНрк░рк╛ркЙркЭрк░ркорк╛ркВ рк╡рлЙркЗрк╕ рк╕рккрлЛрк░рлНркЯ ркиркерлА.");
                micBtn.classList.remove('listening');
                return;
            }
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            
            isListening = true;
            
            recognition.onresult = async function(event) {
                const speechText = event.results[0][0].transcript;
                console.log("ркдркорлЗ ркХрк╣рлНркпрлБркВ:", speechText);
                
                // ркбрк╛ркпрк░рлА ркХркорк╛ркирлНркб
                if (speechText.includes("ркирлЛркВркз ркХрк░рлЛ") || speechText.includes("ркбрк╛ркпрк░рлАркорк╛ркВ рк▓ркЦрлЛ")) {
                    const note = speechText.replace("ркирлЛркВркз ркХрк░рлЛ", "").replace("ркбрк╛ркпрк░рлАркорк╛ркВ рк▓ркЦрлЛ", "").trim();
                    if (note) {
                        const newEntry = {
                            id: Date.now(),
                            date: new Date().toLocaleDateString('gu-IN'),
                            time: new Date().toLocaleTimeString('gu-IN', { hour: '2-digit', minute: '2-digit' }),
                            content: note
                        };
                        diaryEntries.unshift(newEntry);
                        saveDiaryEntries();
                        speak(`ркбрк╛ркпрк░рлАркорк╛ркВ ркирлЛркВркз ркХрк░рлА ркЧркИ ркЫрлБркВ: ${note}`);
                    } else {
                        speak("ркбрк╛ркпрк░рлАркорк╛ркВ рк╢рлБркВ рк▓ркЦрк╡рлБркВ ркЫрлЗ? ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркХрк╣рлЛ.");
                    }
                    isListening = false;
                    return;
                }
                
                // AI ркирлЗ рккрлНрк░рк╢рлНрки
                setVideo('thinking');
                const response = await fetchAI(speechText);
                speak(response);
                isListening = false;
            };
            
            recognition.onerror = function(event) {
                console.error("рк░рлЗркХрлЛркЧрлНркирк┐рк╢рки ркнрлВрк▓:", event.error);
                speak("ркдркорк╛рк░рлЛ ркЕрк╡рк╛ркЬ рк╕ркоркЬрк╛ркпрлЛ ркиркерлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.");
                micBtn.classList.remove('listening');
                isListening = false;
            };
            
            recognition.onend = function() {
                micBtn.classList.remove('listening');
                isListening = false;
            };
            
            recognition.start();
        }

        // тЬЕ FIX 11: Save config
        function saveConfig() {
            const model = document.getElementById('activeModel').value;
            const geminiKeys = document.getElementById('geminiKeys').value;
            const groqKey = document.getElementById('groqKey').value;
            
            localStorage.setItem('div_active_model', model);
            localStorage.setItem('div_gemini_keys', geminiKeys);
            localStorage.setItem('div_groq_key', groqKey);
            
            speak("рк╕рлЗркЯрк┐ркВркЧрлНрк╕ рк╕ркВркЧрлНрк░рк╣рк┐ркд ркХрк░рлА ркЧркИ ркЫрлБркВ");
            toggleModal('settingsModal');
        }

        // тЬЕ FIX 12: Page load
        window.onload = function() {
            console.log("Page loaded");
            
            // Load diary entries
            const savedDiary = localStorage.getItem('div_diary_entries');
            if (savedDiary) {
                try {
                    diaryEntries = JSON.parse(savedDiary);
                } catch(e) {
                    diaryEntries = [];
                }
            }
            
            // Load settings
            document.getElementById('geminiKeys').value = localStorage.getItem('div_gemini_keys') || "";
            document.getElementById('groqKey').value = localStorage.getItem('div_groq_key') || "";
            document.getElementById('activeModel').value = localStorage.getItem('div_active_model') || "groq";
            
            // Hide welcome after delay
            setTimeout(() => {
                const welcomeOverlay = document.getElementById('welcomeOverlay');
                if (welcomeOverlay) {
                    welcomeOverlay.style.display = 'none';
                }
                setVideo('smiling');
                
                setTimeout(() => {
                    speak("рк╣рлБркВ Divinity ркЫрлБркВ, ркдркорк╛рк░рлА AI рк╕рк╣рк╛ркпркХ. ркорк╛рк░рлА рк╕рк╛ркерлЗ ркмрлЛрк▓рлАркирлЗ рк╡рк╛ркд ркХрк░рлЛ. ркбрк╛ркпрк░рлА, рк╡ркВрк╢рк╛рк╡рк│рлА ркЕркирлЗ ркХрлЕркорлЗрк░рк╛ ркорк╛ркЯрлЗ рк╕рлЗркЯрк┐ркВркЧрлНрк╕ркорк╛ркВ ркЬрк╛ркУ.");
                    setVideo('silent');
                }, 1000);
            }, 2000);
            
            // Load vanshavali data
            setTimeout(loadVanshavaliData, 1000);
        };

        // Cleanup on page unload
        window.onbeforeunload = function() {
            stopEverything();
        };
        
        // Touch support
        document.addEventListener('touchstart', function() {}, {passive: true});
    </script>
</body>
</html>
