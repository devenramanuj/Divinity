<!DOCTYPE html>
<html lang="gu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Divinity</title>

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
header{background:#2c3e90;color:#fff;padding:12px;text-align:center;font-size:18px}
.topbar{display:flex;justify-content:flex-end;padding:8px;background:#e9ecff}
.icon{font-size:22px;background:none;border:none}
#avatarWrap{width:260px;margin:16px auto}
#avatarVideo{width:100%;border-radius:16px;background:#000}
#chatBox{height:30vh;overflow-y:auto;background:#fff;margin:12px;padding:12px;border-radius:12px}
.msg{margin-bottom:8px}
.user{text-align:right;color:#2c3e90}
.bot{text-align:left}
.controls{display:flex;gap:10px;padding:12px}
.btn{flex:1;padding:12px;border:none;border-radius:10px;font-size:15px;color:#fff}
.green{background:#1e8449}
.red{background:#c0392b}
#settings{display:none;padding:14px}
.section{background:#fff;padding:12px;border-radius:12px;margin-bottom:12px}
input{width:100%;padding:10px;margin-bottom:10px}
</style>
</head>

<body>

<header>Divinity</header>

<div class="topbar">
  <button class="icon" onclick="toggleSettings()">âš™ï¸</button>
</div>

<div id="avatarWrap">
  <video id="avatarVideo" playsinline muted preload="auto"></video>
</div>

<div id="chat">
  <div id="chatBox"></div>
  <div class="controls">
    <button class="btn green" onclick="startListening()">ğŸ¤ àª¬à«‹àª²à«‹</button>
    <button class="btn red" onclick="stopListening()">â¹ï¸</button>
  </div>
</div>

<div id="settings">
  <div class="section">
    <h4>Contacts</h4>
    <input id="cName" placeholder="Name">
    <input id="cNum" placeholder="Number">
    <button class="btn green" onclick="saveContact()">Save</button>
  </div>

  <div class="section">
    <h4>Diary</h4>
    <input id="dText" placeholder="àª¨à«‹àª‚àª§ àª²àª–à«‹">
    <button class="btn green" onclick="saveDiaryManual()">Save</button>
  </div>
</div>

<script>
/* ---------- Avatar ---------- */
const avatar=document.getElementById("avatarVideo");
const videos={
  silent:"videos/silent.mp4",
  thinking:"videos/thinking.mp4",
  talking:"videos/talking.mp4",
  smiling:"videos/smiling.mp4"
};
function setAvatar(state){
  avatar.pause();
  avatar.src=videos[state];
  avatar.load();
  avatar.play().catch(()=>{});
}
setAvatar("silent");

/* ---------- UI ---------- */
const chatBox=document.getElementById("chatBox");
const settings=document.getElementById("settings");
function toggleSettings(){
  settings.style.display=settings.style.display==="block"?"none":"block";
}
function msg(t,c){
  const d=document.createElement("div");
  d.className="msg "+c;
  d.innerText=t;
  chatBox.appendChild(d);
  chatBox.scrollTop=chatBox.scrollHeight;
}

/* ---------- Storage ---------- */
let db;
const open=indexedDB.open("DivinityDB",1);
open.onupgradeneeded=e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains("contacts"))
    db.createObjectStore("contacts",{keyPath:"name"});
  if(!db.objectStoreNames.contains("diary"))
    db.createObjectStore("diary",{keyPath:"time"});
};
open.onsuccess=e=>db=e.target.result;

/* ---------- Voice ---------- */
let recog;
if("webkitSpeechRecognition"in window){
  recog=new webkitSpeechRecognition();
  recog.lang="gu-IN";
  recog.onstart=()=>setAvatar("thinking");
  recog.onresult=e=>{
    const text=e.results[0][0].transcript;
    msg(text,"user");
    handleCommand(text);
  };
  recog.onend=()=>setAvatar("silent");
}
function startListening(){recog&&recog.start();}
function stopListening(){recog&&recog.stop();}

/* ---------- Commands ---------- */
function handleCommand(text){
  if(text.includes("àª¨à«‹àª‚àª§")){
    saveDiary(text.replace("àª¨à«‹àª‚àª§","").trim());
    return;
  }
  if(text.includes("call")){
    makeCall(text);
    return;
  }
  reply(text);
}

/* ---------- Bot Reply ---------- */
function reply(text){
  const response="àª¹à«àª‚ àª¸àª¾àª‚àª­àª³à«€ àª°àª¹à«€ àª›à«àª‚. àª¹àª¾àª² àª† demo mode àª›à«‡.";
  msg(response,"bot");
  setAvatar("talking");
  speak(response);
}

/* ---------- Speech ---------- */
function speak(t){
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(t);
  u.lang="gu-IN";
  u.onend=()=>setAvatar("smiling");
  speechSynthesis.speak(u);
}

/* ---------- Diary ---------- */
function saveDiary(t){
  const tx=db.transaction("diary","readwrite");
  tx.objectStore("diary").put({time:new Date().toISOString(),text:t});
  msg("àª¨à«‹àª‚àª§ àª¸àª¾àªšàªµà«€ àª²à«€àª§à«€ àª›à«‡","bot");
}
function saveDiaryManual(){
  if(!dText.value)return;
  saveDiary(dText.value);
  dText.value="";
}

/* ---------- Contacts ---------- */
function saveContact(){
  if(!cName.value||!cNum.value)return;
  const tx=db.transaction("contacts","readwrite");
  tx.objectStore("contacts").put({
    name:cName.value.trim(),
    number:cNum.value.trim()
  });
  alert("Contact saved");
}
function makeCall(text){
  const name=text.split("call")[1]?.trim();
  if(!name)return;
  const tx=db.transaction("contacts","readonly");
  const req=tx.objectStore("contacts").get(name);
  req.onsuccess=e=>{
    if(e.target.result)
      location.href="tel:"+e.target.result.number;
    else
      msg("àª¸àª‚àªªàª°à«àª• àª®àª³à«àª¯à«‹ àª¨àª¥à«€","bot");
  };
}
</script>
</body>
</html>
